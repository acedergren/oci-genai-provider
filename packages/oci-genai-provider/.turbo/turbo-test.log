
> @acedergren/oci-genai-provider@0.1.0 test /Users/acedergr/Projects/oci-genai-provider/packages/oci-genai-provider
> jest

PASS src/language-models/converters/__tests__/cohere-messages.test.ts
  convertToCohereFormat
    basic message conversion
      ✓ should convert simple user message (3 ms)
      ✓ should extract system message as preambleOverride
      ✓ should convert chat history correctly (2 ms)
    tool call handling
      ✓ should include toolCalls in chatHistory for assistant messages with tool calls (2 ms)
      ✓ should extract toolResults from TOOL messages (1 ms)
      ✓ should handle multiple tool calls and results (1 ms)
      ✓ should set hasToolResults flag when tool results are present (1 ms)
      ✓ should not set hasToolResults when no tool results present
    edge cases
      ✓ should handle assistant message with tool calls but no text
      ✓ should handle tool call with empty arguments (1 ms)
      ✓ should throw error if no messages provided (9 ms)
      ✓ should throw error if no USER message present (1 ms)

PASS src/language-models/__tests__/OCILanguageModel.cohere-tools.test.ts
  OCILanguageModel - Cohere Tool Calling
    COHERE format with tool results
      ✓ should set isForceSingleStep=true when tool results are present (7 ms)
      ✓ should NOT set isForceSingleStep when no tool results present (2 ms)
      ✓ should include toolCalls in chatHistory for assistant messages (2 ms)
      ✓ should handle multiple tool calls and results (1 ms)

PASS src/realtime/__tests__/OCIRealtimeTranscription.test.ts (9.516 s)
  OCIRealtimeTranscription
    constructor
      ✓ should create session with config (2 ms)
      ✓ should merge config and settings (1 ms)
    connect()
      ✓ should connect to realtime service (634 ms)
      ✓ should emit connected event (627 ms)
      ✓ should support override settings (627 ms)
    event-based API
      ✓ should emit partial events (626 ms)
      ✓ should emit final events (626 ms)
      ✓ should emit result event for final results (625 ms)
      ✓ should support chained on() calls (1 ms)
      ✓ should support off() for removing listeners (627 ms)
    sendAudio()
      ✓ should send audio data (627 ms)
      ✓ should track audio duration (625 ms)
      ✓ should throw if not connected (14 ms)
    async iterator API
      ✓ should implement AsyncIterable (2 ms)
      ✓ should yield results via for-await-of (37 ms)
    sessionInfo
      ✓ should provide session information (627 ms)
      ✓ should track result count (628 ms)
    close()
      ✓ should close connection (627 ms)
      ✓ should emit disconnected event (628 ms)
    normalized results
      ✓ should normalize OCI result format (628 ms)
      ✓ should include token information (626 ms)

PASS src/language-models/__tests__/OCILanguageModel.test.ts
  OCILanguageModel
    Authentication
      ✓ should initialize client with proper auth provider lazily (4 ms)
      ✓ should reuse client across multiple calls (2 ms)
      ✓ should throw helpful error if auth provider creation fails (6 ms)
    Construction
      ✓ should create model with valid model ID (1 ms)
      ✓ should throw error for invalid model ID (1 ms)
      ✓ should have correct specification version
      ✓ should have correct provider identifier (1 ms)
      ✓ should have tool default object generation mode
    doGenerate
      ✓ should return content from response (1 ms)
      ✓ should return usage statistics (1 ms)
      ✓ should include stringified messages in request body for observability (1 ms)
    Compartment ID validation
      ✓ should throw error when compartmentId is missing
      ✓ should use compartmentId from config when provided (1 ms)
    Error handling
      ✓ should wrap 401 errors with APICallError and authentication context (1 ms)
      ✓ should wrap 429 errors with retryable flag (710 ms)
      ✓ should wrap streaming errors with APICallError (714 ms)

PASS src/realtime/__tests__/OCIRealtimeClient.test.ts
  OCIRealtimeClient
    constructor
      ✓ should create client with config (1 ms)
    connect()
      ✓ should connect to realtime service (127 ms)
      ✓ should emit state changes during connection (124 ms)
      ✓ should emit authenticated event with session ID (126 ms)
      ✓ should throw error if already connected (130 ms)
      ✓ should throw error if compartmentId is missing (1 ms)
      ✓ should connect to correct regional endpoint (124 ms)
    sendAudio()
      ✓ should send audio data to WebSocket (125 ms)
      ✓ should throw error if not connected (1 ms)
    message handling
      ✓ should emit RESULT messages (124 ms)
      ✓ should emit error for ERROR messages (125 ms)
    close()
      ✓ should close connection (124 ms)
      ✓ should emit closed event (124 ms)
    event handling
      ✓ should support on/off pattern (125 ms)

PASS src/realtime/__tests__/WebSocketAdapter.test.ts
  WebSocketAdapter
    constructor
      ✓ should create a WebSocket connection (24 ms)
      ✓ should accept connection options (21 ms)
    readyState
      ✓ should report CONNECTING initially (1 ms)
      ✓ should report OPEN after connection (21 ms)
      ✓ should report CLOSED after close (23 ms)
    convenience properties
      ✓ should have isConnecting property (1 ms)
      ✓ should have isOpen property (24 ms)
      ✓ should have isClosed property
    event handling
      ✓ should emit open event when connected (22 ms)
      ✓ should emit close event when closed (22 ms)
      ✓ should emit message event when receiving data (23 ms)
      ✓ should emit error event on WebSocket error (22 ms)
      ✓ should support removing event listeners (21 ms)
    send()
      ✓ should send string data (22 ms)
      ✓ should send ArrayBuffer data (22 ms)
      ✓ should send Uint8Array data (22 ms)
      ✓ should throw error if not connected (6 ms)
    close()
      ✓ should close with default code and reason (22 ms)
      ✓ should close with custom code and reason (21 ms)
      ✓ should be safe to call multiple times (21 ms)
  WebSocketReadyState
    ✓ should have correct values (2 ms)

PASS src/__tests__/utils/__tests__/test-helpers.test.ts
  Test Helpers
    createMockOCIConfig
      ✓ should create valid mock config with defaults (1 ms)
      ✓ should allow overrides (1 ms)
    createMockOCIResponse
      ✓ should create mock language model response
      ✓ should create mock embedding response (1 ms)
    mockOCIError
      ✓ should create mock rate limit error (1 ms)
      ✓ should create mock authentication error (1 ms)
    waitForCondition
      ✓ should resolve when condition becomes true (103 ms)
      ✓ should timeout if condition never becomes true (103 ms)

PASS src/__tests__/e2e-workflows.test.ts
  E2E Workflows
    RAG Pipeline
      RAG: Embed → Rerank → Generate
        ✓ should complete full RAG workflow with embeddings, reranking, and generation (1 ms)
        ✓ should handle document corpus embedding in RAG workflow
        ✓ should rerank retrieved documents based on query relevance (1 ms)
        ✓ should generate response using top reranked documents
        ✓ should pipeline models with config sharing across RAG workflow (1 ms)
      RAG Edge Cases
        ✓ should handle empty document corpus (1 ms)
        ✓ should handle large document corpus efficiently (1 ms)
        ✓ should handle multilingual documents in RAG
    Multimodal Pipeline
      Multimodal: Speech → Transcription → Generation
        ✓ should complete speech synthesis workflow (1 ms)
        ✓ should complete transcription workflow (1 ms)
        ✓ should handle full speech-to-text-to-speech loop
        ✓ should handle multimodal response generation with text and audio (1 ms)
        ✓ should maintain context across multimodal transformations (1 ms)
      Multimodal Edge Cases
        ✓ should handle audio with different sample rates
        ✓ should handle multilingual speech synthesis (1 ms)
        ✓ should handle very long audio for transcription (1 ms)
    Error Handling Pipeline
      Graceful Error Handling Across Model Types
        ✓ should handle rate limit errors gracefully (2 ms)
        ✓ should handle authentication errors across provider (1 ms)
        ✓ should handle service unavailable errors (3 ms)
        ✓ should handle model not found errors (2 ms)
        ✓ should provide error context across model types (3 ms)
      Error Recovery and Retry Logic
        ✓ should support retry mechanism for transient errors (3 ms)
        ✓ should handle circuit breaker pattern for repeated failures (2 ms)
        ✓ should handle degraded service mode (1 ms)
      Error Propagation and Logging
        ✓ should provide detailed error information for debugging (2 ms)
        ✓ should handle error correlation across service calls (2 ms)
      Error Scenarios in Complex Workflows
        ✓ should recover from error in RAG pipeline embedding step (1 ms)
        ✓ should handle error in multimodal pipeline transcription step (3 ms)
        ✓ should provide partial results on partial pipeline failure (1 ms)
    Workflow Integration Tests
      ✓ should create all model types successfully in single workflow (2 ms)
      ✓ should merge provider config with model-specific settings in workflows (2 ms)
      ✓ should handle optional model methods correctly (3 ms)
      ✓ should throw NoSuchModelError for imageModel (20 ms)
    Performance and Scale Considerations
      ✓ should handle concurrent model creation (2 ms)
      ✓ should reuse provider instances across workflows (1 ms)
      ✓ should handle rapid sequential model creation (3 ms)

PASS src/__tests__/provider.test.ts
  createOCI Provider Factory (ProviderV3)
    Factory Creation
      ✓ should create provider with default config (1 ms)
      ✓ should create provider with Frankfurt region (1 ms)
      ✓ should create provider with custom profile
      ✓ should create provider with compartment ID (1 ms)
      ✓ should create provider with instance principal auth (1 ms)
    Model Creation via languageModel()
      ✓ should create language model instance
      ✓ should create Grok model (1 ms)
      ✓ should create Llama model (1 ms)
      ✓ should create Cohere model (1 ms)
      ✓ should create Gemini model
      ✓ should throw error for invalid model ID (11 ms)
    Configuration Cascade
      ✓ should prioritize config over environment
      ✓ should use environment when config not provided
      ✓ should use Frankfurt as final default (1 ms)
    oci default instance
      ✓ should export default provider instance
      ✓ should create language models from default instance (1 ms)
  OCIGenAIProvider (ProviderV3)
    specificationVersion
      ✓ should have specificationVersion V3 (1 ms)
    languageModel()
      ✓ should create language model with model ID (1 ms)
      ✓ should pass config to language models
      ✓ should merge provider config with model-specific settings (1 ms)
      ✓ should throw error for invalid model ID (1 ms)
    embeddingModel()
      ✓ should create embedding model instance
      ✓ should create different embedding models (1 ms)
      ✓ should merge provider config with embedding-specific settings (1 ms)
      ✓ should throw error for invalid embedding model ID (1 ms)
    imageModel()
      ✓ should throw NoSuchModelError - OCI does not support image generation (1 ms)
      ✓ should include helpful message about OCI limitations (1 ms)
    transcriptionModel()
      ✓ should create transcription model with valid ID
      ✓ should create Oracle transcription model
      ✓ should throw error for invalid model ID (2 ms)
    speechModel()
      ✓ should create speech model with valid ID (1 ms)
      ✓ should create TTS_1_STANDARD model (1 ms)
      ✓ should throw error for invalid model ID (1 ms)
    rerankingModel()
      ✓ should create reranking model (1 ms)
      ✓ should merge config with reranking-specific settings
      ✓ should throw for invalid reranking model ID (2 ms)
    Integration Tests
      ✓ should create all model types successfully (1 ms)
      ✓ should merge provider config with model-specific settings
      ✓ should merge embedding config with model-specific settings (1 ms)
      ✓ should merge reranking config with model-specific settings (1 ms)
      ✓ should throw NoSuchModelError for imageModel (1 ms)
      ✓ should include helpful error message for imageModel
      ✓ should have all optional provider methods defined (1 ms)
      ✓ should preserve provider config across multiple model creations (1 ms)
      ✓ should allow region override in speech model creation
      ✓ should allow region override in transcription model creation
      ✓ should support config merging for all model types with requestOptions (1 ms)
      ✓ should create speech model with voice configuration override (12 ms)
      ✓ should handle empty provider config (1 ms)
      ✓ should throw for invalid language model ID format (1 ms)
      ✓ should throw for invalid embedding model ID format (1 ms)
      ✓ should throw for invalid speech model ID format (1 ms)
      ✓ should throw for invalid transcription model ID format (1 ms)
      ✓ should throw for invalid reranking model ID format
    realtimeTranscription()
      ✓ should create realtime transcription session
      ✓ should accept realtime-specific settings (1 ms)
      ✓ should merge provider config with realtime settings (1 ms)
      ✓ should implement AsyncIterable (1 ms)

PASS src/__tests__/regression.test.ts
  Regression: Provider Configuration
    ✓ REG-001: Provider must accept compartmentId from environment (1 ms)
    ✓ REG-002: Provider must accept region configuration (1 ms)
    ✓ REG-003: Provider must accept explicit config options (1 ms)
    ✓ REG-004: Provider must create valid language model
    ✓ REG-005-008: Provider must support cohere.command-r-plus model family (1 ms)
    ✓ REG-005-008: Provider must support google.gemini-2.5-pro model family (1 ms)
    ✓ REG-005-008: Provider must support xai.grok-4 model family
    ✓ REG-005-008: Provider must support meta.llama-3.3-70b-instruct model family (1 ms)
  Regression: Model Creation & Error Handling
    ✓ REG-009: languageModel() must return LanguageModelV3 interface
    ✓ REG-010: Provider name must be oci-genai (1 ms)
    ✓ REG-011: chat() must be alias for languageModel()
    ✓ REG-012: Invalid model ID should throw NoSuchModelError (8 ms)
    ✓ REG-013: Empty model ID should throw (1 ms)
    ✓ REG-014: imageModel() should throw (not supported)
  Regression: Model Registry
    ✓ REG-015: isValidModelId(cohere.command-r-plus) must return true (1 ms)
    ✓ REG-015: isValidModelId(meta.llama-3.3-70b-instruct) must return true
    ✓ REG-015: isValidModelId(xai.grok-4) must return true
    ✓ REG-015: isValidModelId(google.gemini-2.5-pro) must return true (1 ms)
    ✓ REG-016: isValidModelId(unknown.model) must return false
    ✓ REG-016: isValidModelId(future.new-model) must return false
    ✓ REG-016: isValidModelId() must return false (1 ms)
    ✓ REG-017: getModelMetadata must return info for known models
    ✓ REG-018: getModelMetadata must return undefined for unknown models
    ✓ REG-019: getAllModels must return non-empty array with all families
    ✓ REG-021: getModelsByFamily(cohere) must filter correctly
    ✓ REG-021: getModelsByFamily(grok) must filter correctly (1 ms)
  Regression: Provider Specification
    ✓ REG-022: Default oci export must be valid provider
    ✓ REG-023: Provider must expose models catalog (1 ms)
  Regression: Serving Mode Configuration
    ✓ REG-024: Provider must accept on-demand serving mode
    ✓ REG-025: Provider must accept dedicated serving mode with endpointId (1 ms)
    ✓ REG-026: Provider must accept endpointId from environment

PASS src/transcription-models/__tests__/OCITranscriptionModel.test.ts
  OCITranscriptionModel
    ✓ should have correct specification version and provider (1 ms)
    ✓ should accept WHISPER_MEDIUM model ID (1 ms)
    ✓ should accept WHISPER_LARGE_V2 model ID
    ✓ should throw error for invalid model ID (8 ms)
    ✓ should reject old-style model IDs
    ✓ should accept language setting (1 ms)
    ✓ should accept custom vocabulary for Oracle model
    ✓ should warn about vocabulary for Whisper model (1 ms)
    audio validation
      ✓ should throw error when audio exceeds 2GB limit
      ✓ should accept audio under 2GB limit (1 ms)
    response structure
      ✓ should return all required TranscriptionOutput properties (1 ms)
      ✓ should include providerMetadata with jobId (1 ms)
    warnings
      ✓ should add warning when using vocabulary with Whisper model
      ✓ should have empty warnings when vocabulary not used (1 ms)
    language handling
      ✓ should return configured language (1 ms)
      ✓ should return undefined when language not configured
    Object Storage integration
      ✓ should use custom bucket when configured (1 ms)
      ✓ should cleanup uploaded file after transcription
    base64 audio input
      ✓ should accept base64-encoded audio string (1 ms)
    custom endpoint
      ✓ should set endpoint on client when configured
    error paths
      ✓ should throw wrapped error when upload fails (1 ms)
      ✓ should throw when no transcription tasks found in job (1 ms)
      ✓ should throw wrapped error when getting task details fails (1 ms)
      ✓ should use fallback output filename when task has no outputLocation
      ✓ should throw wrapped error when download result fails
      ✓ should throw when transcription job enters FAILED state (1 ms)
      ✓ should throw timeout after max poll attempts (22 ms)
      ✓ should silently ignore cleanup errors after transcription (1 ms)

PASS src/language-models/__tests__/OCILanguageModel-retry.test.ts
  OCILanguageModel Retry and Timeout Integration
    Retry behavior
      ✓ should retry on transient 500 errors and eventually succeed (5 ms)
      ✓ should retry on 429 rate limit errors (2 ms)
      ✓ should retry on network errors (ECONNRESET) (2 ms)
      ✓ should NOT retry on 401 authentication errors (9 ms)
      ✓ should NOT retry on 400 bad request errors (1 ms)
      ✓ should exhaust retries and throw final error (4 ms)
      ✓ should respect retry.enabled = false (1 ms)
    Timeout behavior
      ✓ should timeout on slow requests (12 ms)
      ✓ should succeed if request completes within timeout (1 ms)
    Configuration options
      ✓ should use default options when none provided (1 ms)
      ✓ should merge config options with defaults (1 ms)
      ✓ should allow custom timeout values (1 ms)
    Streaming with retry
      ✓ should retry connection establishment for streaming (2 ms)
    Error handling integration
      ✓ should wrap errors with APICallError after retry exhaustion (2 ms)
      ✓ should preserve original error message after retries (2 ms)

PASS src/reranking-models/__tests__/OCIRerankingModel.test.ts
  OCIRerankingModel
    ✓ should have correct specification version and provider (1 ms)
    ✓ should throw error for invalid model ID (6 ms)
    getClient
      ✓ should initialize client with auth provider and region (3 ms)
      ✓ should set custom endpoint if provided
      ✓ should reuse existing client on subsequent calls (1 ms)
    document type validation
      ✓ should throw error for non-text documents
      ✓ should accept text documents
    document count validation
      ✓ should validate document count does not exceed max (1 ms)
      ✓ should accept maximum allowed documents (1 ms)
    doRerank
      ✓ should rerank documents successfully (1 ms)
      ✓ should call OCI API with correct parameters
      ✓ should use custom topN setting from config (1 ms)
      ✓ should pass topN from call options (1 ms)
      ✓ should use returnDocuments setting (maps to isEcho)
      ✓ should handle missing relevanceScore gracefully (1 ms)
      ✓ should handle missing index gracefully
      ✓ should handle API errors gracefully (8 ms)
      ✓ should handle empty document ranks (1 ms)
    edge cases
      ✓ should handle single document (1 ms)
      ✓ should handle empty query
      ✓ should handle very long query
      ✓ should handle text documents

PASS src/shared/streaming/__tests__/sse-parser.test.ts
  SSE Parser
    mapFinishReason
      ✓ should map STOP to stop (1 ms)
      ✓ should map LENGTH to length (1 ms)
      ✓ should map CONTENT_FILTER to content-filter
      ✓ should map unknown to other
      ✓ should map empty string to other
    SSE data format
      ✓ should recognize text delta event structure
      ✓ should recognize finish event structure
      ✓ should yield text-delta parts (1 ms)
      ✓ should yield finish part with usage
    SSE parsing edge cases
      ✓ should handle done event marker
      ✓ should handle malformed JSON gracefully (1 ms)
      ✓ should handle empty events
    Performance
      ✓ should parse 1000 events in under 100ms (7 ms)
    parseSSEStream
      ✓ should parse text delta from stream
      ✓ should parse finish event from stream (1 ms)
      ✓ should handle empty event data
      ✓ should handle error event parsing (1 ms)
      ✓ should handle malformed JSON in events gracefully
      ✓ should handle multiple consecutive newlines
      ✓ should handle mixed line endings (CRLF vs LF) (1 ms)
      ✓ should throw when response body is not readable (7 ms)
      ✓ should yield remaining parts after stream completes (1 ms)
      ✓ should handle large chunked streams with buffered parts (1 ms)
      ✓ should handle events with whitespace in data fields
      ✓ should handle [DONE] marker correctly (1 ms)
      ✓ should parse GENERIC format tool calls from stream
      ✓ should parse COHERE format tool calls from stream (1 ms)
      ✓ should parse multiple tool calls from stream
      ✓ should parse text followed by tool calls
      ✓ should parse finish event with prediction token details (1 ms)
      ✓ should handle finish event without prediction token details
      ✓ should handle partial prediction token details (1 ms)

PASS src/shared/utils/__tests__/retry.test.ts
  withRetry
    ✓ should return result on first success (1 ms)
    ✓ should not retry on 4xx client errors (5 ms)
    ✓ should use custom isRetryable function (1 ms)
    ✓ should retry on transient error and succeed (2 ms)
    ✓ should throw after max retries exceeded (5 ms)
    ✓ should retry on 5xx server errors (1 ms)
    ✓ should respect custom retry options (1 ms)
  withRetry exponential backoff
    ✓ should use exponential backoff (5 ms)
    ✓ should cap delay at maxDelayMs (7 ms)
  isRetryableError
    ✓ should return true for network errors
    ✓ should return true for ECONNREFUSED errors
    ✓ should return true for EAI_AGAIN DNS errors (1 ms)
    ✓ should return true for 5xx errors
    ✓ should return true for 500 Internal Server Error
    ✓ should return true for 502 Bad Gateway
    ✓ should return true for 429 rate limit (1 ms)
    ✓ should return false for 4xx client errors
    ✓ should return false for 400 Bad Request
    ✓ should return false for 401 Unauthorized
    ✓ should return false for 403 Forbidden
    ✓ should return false for non-retryable errors
    ✓ should return false for non-Error values
    ✓ should check statusCode property as fallback (1 ms)
    ✓ should check error code property
    ✓ should return true for fetch failed errors
    ✓ should return true for network error messages (1 ms)

PASS src/speech-models/__tests__/OCISpeechModel.test.ts
  OCISpeechModel
    ✓ should have correct specification version and provider (2 ms)
    ✓ should throw error for invalid model ID (8 ms)
    ✓ should reject old-style model IDs (1 ms)
    ✓ should allow any region (no Phoenix-only restriction) (1 ms)
    ✓ should validate text length does not exceed max (1 ms)
    Voice Selection
      ✓ should use config.voice when provided (highest priority)
      ✓ should fallback to metadata defaultVoice if config voice not provided (1 ms)
      ✓ should fallback to hardcoded default when no defaultVoice in registry
      ✓ should fallback to en-US-AriaNeural if both config and metadata voice are undefined (1 ms)
      ✓ should prefer config.voice over default
    doGenerate
      ✓ should generate audio successfully for valid text (3 ms)
      ✓ should return timestamp in response (1 ms)
      ✓ should include request body in response (1 ms)
      ✓ should include providerMetadata with voice and format (2 ms)
      ✓ should pass correct modelName to OCI SDK (1 ms)
    format mapping
      ✓ should default to mp3 format when not specified (3 ms)

PASS src/shared/schemas/__tests__/provider-options.test.ts
  OCIProviderOptionsSchema
    valid options
      ✓ should accept empty options (1 ms)
      ✓ should accept valid reasoningEffort values (1 ms)
      ✓ should accept thinking with tokenBudget
      ✓ should accept valid servingMode object (1 ms)
      ✓ should accept dedicated servingMode with endpointId
      ✓ should accept valid endpoint URL
      ✓ should accept compartmentId
      ✓ should accept requestOptions
    invalid options
      ✓ should reject invalid reasoningEffort (1 ms)
      ✓ should reject negative tokenBudget (1 ms)
      ✓ should reject zero tokenBudget
      ✓ should reject non-integer tokenBudget (1 ms)
      ✓ should reject invalid servingMode type
      ✓ should reject servingMode as string
      ✓ should reject invalid endpoint URL (1 ms)
      ✓ should reject invalid requestOptions.timeoutMs
    discriminated union for servingMode
      ✓ should require modelId for ON_DEMAND serving mode (1 ms)
      ✓ should require endpointId for DEDICATED serving mode
      ✓ should accept ON_DEMAND with modelId
      ✓ should accept DEDICATED with endpointId (1 ms)
    strict mode - unknown keys rejected
      ✓ should reject unknown top-level keys
      ✓ should reject unknown keys in requestOptions (1 ms)
      ✓ should reject unknown keys in retry config
    cross-field validation
      ✓ should reject tokenBudget without thinking enabled (1 ms)
      ✓ should reject tokenBudget when thinking is false
      ✓ should accept tokenBudget when thinking is true
      ✓ should accept thinking without tokenBudget (1 ms)
    parseProviderOptions helper
      ✓ should return validated options
      ✓ should throw OCIValidationError for invalid options (7 ms)
      ✓ should include error details in OCIValidationError
      ✓ should handle undefined gracefully (1 ms)
      ✓ should handle null gracefully
      ✓ should validate nested requestOptions (1 ms)
    type inference
      ✓ should correctly infer types from schema
      ✓ should narrow servingMode type based on discriminator (1 ms)

PASS src/shared/schemas/__tests__/provider-settings.test.ts
  CompartmentIdSchema
    ✓ ZOD-001: accepts valid compartment OCID (1 ms)
    ✓ ZOD-002: rejects invalid compartment OCID format (1 ms)
    ✓ ZOD-003: rejects empty string (1 ms)
  RegionSchema
    ✓ ZOD-004: accepts valid region format
    ✓ ZOD-005: rejects invalid region format
    ✓ ZOD-006: rejects AWS-style region format (1 ms)
  ServingModeSchema
    ✓ ZOD-007: accepts on-demand mode
    ✓ ZOD-008: accepts dedicated mode (1 ms)
    ✓ ZOD-009: rejects invalid mode
    ✓ ZOD-010: defaults to on-demand when parsing undefined (1 ms)
  EndpointIdSchema
    ✓ ZOD-011: accepts valid endpoint OCID
    ✓ ZOD-012: rejects non-OCID endpoint
  OCIProviderSettingsSchema
    ✓ ZOD-013: accepts valid on-demand settings
    ✓ ZOD-014: accepts valid dedicated settings with endpointId
    ✓ ZOD-015: rejects dedicated mode without endpointId (1 ms)
    ✓ ZOD-016: accepts empty settings object
    ✓ ZOD-017: accepts settings with only configProfile
  validateProviderSettings
    ✓ ZOD-018: returns success for valid settings (1 ms)
    ✓ ZOD-019: returns error for invalid settings
  parseProviderSettings
    ✓ ZOD-020: throws OCIValidationError for invalid settings (5 ms)
    ✓ ZOD-021: returns parsed settings for valid input
    ✓ ZOD-026: includes validation issues in OCIValidationError (1 ms)
    ✓ ZOD-027: error message includes field path
  OcidSchema
    ✓ ZOD-028: accepts valid generic OCID
    ✓ ZOD-029: rejects invalid OCID format
  ModelIdSchema
    ✓ ZOD-022: accepts non-empty model ID (1 ms)
    ✓ ZOD-023: rejects empty model ID
  OCIChatModelIdSchema
    ✓ ZOD-024: accepts simple model ID object (1 ms)
    ✓ ZOD-025: accepts dedicated endpoint model ID

PASS src/language-models/__tests__/registry.test.ts
  Model Registry
    isValidModelId
      ✓ should reject completely invalid model ID
      Grok models
        ✓ should validate xai.grok-code-fast-1 (1 ms)
        ✓ should validate xai.grok-4-1-fast-reasoning
        ✓ should validate xai.grok-4-1-fast-non-reasoning (1 ms)
        ✓ should validate xai.grok-4-fast-reasoning
        ✓ should validate xai.grok-4-fast-non-reasoning (1 ms)
        ✓ should validate xai.grok-3 (1 ms)
        ✓ should validate xai.grok-3-mini
        ✓ should reject invalid Grok model (1 ms)
      Llama models
        ✓ should validate meta.llama-3.3-70b-instruct
        ✓ should validate meta.llama-3.2-90b-vision-instruct
        ✓ should validate meta.llama-3.1-405b-instruct
      Cohere models
        ✓ should validate cohere.command-r-plus (1 ms)
        ✓ should validate cohere.command-plus-latest (1 ms)
        ✓ should validate cohere.command-latest
        ✓ should validate cohere.command-a-03-2025
        ✓ should validate cohere.command-a-reasoning (1 ms)
        ✓ should validate cohere.command-a-vision
      Gemini models
        ✓ should validate google.gemini-2.5-pro (1 ms)
        ✓ should validate google.gemini-2.5-flash
        ✓ should validate google.gemini-2.5-flash-lite
    getModelMetadata
      ✓ should return Grok Code Fast metadata
      ✓ should return Gemini Flash with vision capability (1 ms)
      ✓ should return Llama Vision metadata
      ✓ should return undefined for invalid model (1 ms)
      ✓ should include all required metadata fields
    getAllModels
      ✓ should return all models (16+ models) (1 ms)
      ✓ should include models from all families
    getModelsByFamily
      ✓ should return Grok models (1 ms)
      ✓ should return Llama models
      ✓ should return Cohere models (1 ms)
      ✓ should return Gemini models
      ✓ should return empty array for unknown family (1 ms)
    supportsReasoning
      ✓ should return false for invalid model ID
      reasoning-capable models
        ✓ should return false for xai.grok-4-1-fast-reasoning (no API support)
        ✓ should return false for xai.grok-4-fast-reasoning (no API support)
        ✓ should return true for cohere.command-a-reasoning-08-2025
        ✓ should return true for cohere.command-a-reasoning (1 ms)
      non-reasoning models
        ✓ should return false for meta.llama-3.3-70b-instruct
        ✓ should return false for cohere.command-r-plus
        ✓ should return true for google.gemini-2.5-flash (supports reasoning) (1 ms)
        ✓ should return false for xai.grok-4-1-fast-non-reasoning

PASS src/config/__tests__/oci-config.test.ts
  parseOCIConfig
    ✓ should parse a valid OCI config file (3 ms)
    ✓ should return found=false when config file does not exist
    ✓ should handle missing key files gracefully (1 ms)
    ✓ should handle comments and empty lines
    ✓ should handle custom config path
  expandPath
    ✓ should expand ~ to home directory
    ✓ should expand ~/subdir paths (1 ms)
    ✓ should leave absolute paths unchanged
    ✓ should leave relative paths unchanged (1 ms)
    ✓ should handle empty string
  hasOCIConfig
    ✓ should return true when config exists and has content (1 ms)
    ✓ should return false when config does not exist (1 ms)
    ✓ should return false when config is empty
    ✓ should return false when statSync throws (1 ms)
  getConfigPath
    ✓ should return default path when OCI_CONFIG_FILE not set
    ✓ should return OCI_CONFIG_FILE when set (1 ms)
    ✓ should expand ~ in OCI_CONFIG_FILE
  getProfile
    ✓ should return profile by name (1 ms)
    ✓ should return DEFAULT profile when no name specified
    ✓ should return undefined for non-existent profile (1 ms)
    ✓ should return undefined when config file not found

PASS src/shared/storage/__tests__/object-storage.test.ts
  downloadTranscriptionResult
    ✓ should parse valid OCI Speech JSON format and return transcription result (2 ms)
    ✓ should handle missing transcription field gracefully (7 ms)
    ✓ should handle invalid JSON parsing
    ✓ should handle stream read errors (1 ms)
    ✓ should handle empty token arrays (1 ms)
    ✓ should group tokens into segments based on 1-second gap threshold (2 ms)
    ✓ should preserve token confidence in extracted data
    ✓ should handle missing optional metadata fields (1 ms)
    ✓ should skip tokens with missing required fields (1 ms)
  uploadAudioToObjectStorage
    ✓ should upload audio and return location details (1 ms)
  deleteFromObjectStorage
    ✓ should delete an object from Object Storage
  generateAudioObjectName
    ✓ should generate a name matching the audio-{timestamp}-{random}.wav pattern (1 ms)
    ✓ should generate unique names on successive calls

PASS src/embedding-models/__tests__/OCIEmbeddingModel.test.ts
  OCIEmbeddingModel
    ✓ should have correct specification version and provider (1 ms)
    ✓ should set maxEmbeddingsPerCall to 96 (1 ms)
    ✓ should throw error for invalid model ID (5 ms)
    ✓ should validate embeddings count does not exceed max (1 ms)
    getClient
      ✓ should initialize client with auth provider (3 ms)
      ✓ should reuse client on subsequent calls (1 ms)
      ✓ should set custom endpoint when provided (1 ms)
    doEmbed
      ✓ should generate embeddings successfully
      ✓ should call OCI API with correct parameters (1 ms)
      ✓ should use custom truncate setting (1 ms)
      ✓ should use custom inputType setting
      ✓ should handle API errors gracefully (3 ms)
      ✓ should calculate token usage based on text length (1 ms)
      ✓ should handle single embedding request (1 ms)
      ✓ should handle empty values array (1 ms)
    model validation
      ✓ should accept cohere.embed-english-v3.0
      ✓ should accept cohere.embed-english-light-v3.0 (1 ms)
      ✓ should support parallel calls

PASS src/auth/__tests__/auth.test.ts
  createAuthProvider
    ✓ should create config file auth provider by default (1 ms)
    ✓ should use custom profile when provided
    ✓ should create instance principal auth when specified (1 ms)
    ✓ should throw error for unsupported auth method (3 ms)
    ✓ should create resource principal auth when specified
    ✓ should use custom config path when provided (1 ms)
  getCompartmentId
    ✓ should return compartment ID from config (1 ms)
    ✓ should return compartment ID from environment when not in config
    ✓ should prioritize config over environment (1 ms)
    ✓ should throw error when no compartment ID available (1 ms)
  getRegion
    ✓ should return region from config
    ✓ should return region from environment when not in config (1 ms)
    ✓ should use Frankfurt as default
    ✓ should prioritize config over environment (1 ms)

PASS src/shared/utils/__tests__/timeout.test.ts
  withTimeout
    ✓ should return result if function completes before timeout (2 ms)
    ✓ should throw TimeoutError if function exceeds timeout (5 ms)
    ✓ should include custom message in TimeoutError (1 ms)
    ✓ should clear timeout on successful completion (2 ms)
    ✓ should clear timeout on function error (1 ms)
    ✓ should propagate function errors, not timeout errors (1 ms)
    ✓ should handle zero timeout (immediate timeout) (1 ms)
  TimeoutError
    ✓ should be instanceof Error (1 ms)
    ✓ should have correct name
    ✓ should expose timeoutMs property
    ✓ should have descriptive message (1 ms)
    ✓ should include operation name in message

PASS src/shared/errors/__tests__/errors.test.ts
  OCIGenAIError
    ✓ should be instanceof Error
    ✓ should have correct name (1 ms)
    ✓ should preserve cause
    ✓ should have retryable property
  NetworkError
    ✓ should extend OCIGenAIError
    ✓ should have correct name (1 ms)
    ✓ should indicate retryable by default
    ✓ should expose error code
    ✓ should preserve cause (1 ms)
  RateLimitError
    ✓ should extend OCIGenAIError
    ✓ should have correct name
    ✓ should indicate retryable (1 ms)
    ✓ should expose retryAfter when provided
    ✓ should have undefined retryAfter when not provided
    ✓ should preserve cause (1 ms)
  AuthenticationError
    ✓ should extend OCIGenAIError
    ✓ should have correct name
    ✓ should not be retryable (1 ms)
    ✓ should expose authentication type
    ✓ should support instance_principal auth type
    ✓ should preserve cause (1 ms)
  ModelNotFoundError
    ✓ should extend OCIGenAIError
    ✓ should have correct name (1 ms)
    ✓ should not be retryable
    ✓ should expose model ID
    ✓ should have descriptive message (1 ms)
    ✓ should preserve cause

PASS src/language-models/__tests__/OCILanguageModel.stream.test.ts
  OCILanguageModel.doStream
    ✓ should return stream result with stream property (2 ms)
    ✓ should stream text deltas
    ✓ should include finish part with usage (1 ms)
    ✓ should include raw parts when includeRawChunks is true (1 ms)
    ✓ should set isStream flag in request
    ✓ should include temperature in streaming request
    ✓ should include maxTokens in streaming request

PASS src/language-models/converters/__tests__/messages.test.ts
  Message Conversion
    convertToOCIMessages
      ✓ should convert simple user message (1 ms)
      ✓ should convert system message (2 ms)
      ✓ should convert assistant message (1 ms)
      ✓ should convert multi-turn conversation (1 ms)
      ✓ should handle string content format (1 ms)
      ✓ should handle array content format
      ✓ should handle empty content
      ✓ should filter out non-text content parts (1 ms)
      ✓ should handle image content type (via file type) (1 ms)
      ✓ should handle file content type (non-text branch)
      ✓ should handle image content type (non-text branch) (1 ms)
      ✓ should handle file content type (non-text branch)
      ✓ should handle mixed text and image content types
      ✓ should handle mixed text, image, and file content types (1 ms)
      ✓ should handle assistant message with non-text content
      ✓ should handle user message with only non-text content (1 ms)
      ✓ should handle content that is not string or array (edge case for branch coverage)
      ✓ should throw error for unsupported role (8 ms)
    Tool Parts
      ✓ should convert assistant message with tool-call part (1 ms)
      ✓ should convert assistant message with string input in tool-call
      ✓ should convert assistant message with text and tool-call parts (1 ms)
      ✓ should convert tool message with tool-result part
      ✓ should convert multiple tool calls in one message (1 ms)
      ✓ should handle undefined input in tool-call
    Performance
      ✓ should convert messages with 100 parts in under 5ms (1 ms)

PASS src/language-models/converters/__tests__/tools.test.ts
  Tool Converters
    convertToOCITools
      ✓ should convert AI SDK function tools to OCI GENERIC format (1 ms)
      ✓ should convert AI SDK function tools to OCI COHERE format
      ✓ should handle tools with no properties (1 ms)
      ✓ should handle tools with no description
    convertToOCIToolChoice
      ✓ should convert auto tool choice (1 ms)
      ✓ should convert required tool choice
      ✓ should convert none tool choice
      ✓ should convert tool-specific choice
    convertFromOCIToolCalls
      ✓ should convert OCI GENERIC format tool calls to AI SDK format (1 ms)
      ✓ should convert OCI COHERE format tool calls to AI SDK format
      ✓ should handle invalid JSON in arguments gracefully (1 ms)
      ✓ should handle multiple tool calls
    supportsToolCalling
      ✓ should return true for Llama 3.1+ models
      ✓ should return false for older Llama models (1 ms)
      ✓ should return true for Cohere Command R models
      ✓ should return false for older Cohere models
      ✓ should return true for Grok models (1 ms)
      ✓ should return true for Gemini models
      ✓ should return false for unknown models

PASS src/language-models/__tests__/OCILanguageModel.advanced.test.ts
  OCILanguageModel - Advanced V3 Features
    Vision (Multimodal)
      ✓ should convert file parts (images) to OCI format for Generic models (3 ms)
      ✓ should convert file parts (images) to OCI format for Cohere V2 models (2 ms)
    Reasoning
      ✓ should support reasoning settings for Generic models (1 ms)
      ✓ should support reasoning settings for Cohere models (2 ms)
      ✓ should stream reasoning deltas (1 ms)

PASS src/config/__tests__/validation.test.ts
  validateCredentials
    ✓ should return valid=true for working credentials (2 ms)
    ✓ should return valid=false for authentication failures (2 ms)
    ✓ should return valid=false for timeout errors (1 ms)
    ✓ should return valid=false for missing key file
    ✓ should handle generic errors gracefully (1 ms)
    ✓ should use DEFAULT profile when none specified (1 ms)

PASS src/__tests__/errors.test.ts
  Error Handling
    OCIGenAIError
      ✓ should create error with message
      ✓ should include status code
      ✓ should mark as retryable
      ✓ should mark as non-retryable by default (1 ms)
    isRetryableError
      ✓ should identify 429 as retryable
      ✓ should identify 500 as retryable
      ✓ should identify 503 as retryable (1 ms)
      ✓ should mark 400 as non-retryable
      ✓ should mark 401 as non-retryable
      ✓ should mark 403 as non-retryable (1 ms)
      ✓ should mark 404 as non-retryable
    handleOCIError
      ✓ should add auth context to 401 errors
      ✓ should add IAM context to 403 errors (1 ms)
      ✓ should add model context to 404 errors
      ✓ should add rate limit context to 429 errors
      ✓ should preserve original message
      ✓ should wrap non-OCI errors
    Error Integration
      ✓ should convert OCIGenAIError to APICallError
      ✓ should set retryable based on status code (1 ms)
      ✓ should preserve status code in wrapped error

PASS src/language-models/__tests__/seed-parameter.test.ts
  OCILanguageModel - seed parameter
    ✓ should pass seed parameter in non-streaming requests (3 ms)
    ✓ should pass seed parameter in streaming requests (1 ms)
    ✓ should not include seed parameter when not provided (1 ms)

PASS src/__tests__/docs-validation.test.ts
  Documentation Validation
    README completeness
      ✓ README should document all model types (2 ms)
      ✓ README should include installation instructions
      ✓ README should document authentication (1 ms)
      ✓ README should link to examples
      ✓ README should document regional availability (1 ms)
    API Reference Documentation
      ✓ should document all provider methods
      ✓ should document createOCI factory
    Configuration Guide
      ✓ should document configuration methods (1 ms)
    Migration Guide
      ✓ should document breaking changes
    Troubleshooting Guide
      ✓ should document common issues (1 ms)

PASS src/__tests__/mocks/__tests__/oci-mocks.test.ts
  OCI Mocks
    mockGenerativeAiInferenceClient
      ✓ should create mock client with default responses
      ✓ should allow custom response setup (1 ms)
      ✓ should have chat method callable
    mockAuthProvider
      ✓ should create valid auth provider mock (1 ms)
    resetAllMocks
      ✓ should be callable without error

PASS src/__tests__/types.test.ts
  OCIConfig
    ✓ should allow optional region configuration (1 ms)
    ✓ should allow all authentication methods
  OCILanguageModelSettings
    ✓ should support all OCIConfig fields plus requestOptions
  OCIEmbeddingSettings
    ✓ should have embedding-specific options (1 ms)
    ✓ should accept 384 dimensions for light models
  OCISpeechSettings
    ✓ should have TTS-specific options
  OCITranscriptionSettings
    ✓ should have STT-specific options (1 ms)
  OCIRerankingSettings
    ✓ should have reranking-specific options

PASS src/config/__tests__/discovery.test.ts
  discoverCompartments
    ✓ should discover compartments from OCI API (1 ms)
    ✓ should exclude root compartment when includeRoot=false (1 ms)
    ✓ should handle empty compartment list
    ✓ should include compartment descriptions (1 ms)
    ✓ should preserve lifecycle state
    ✓ should use DEFAULT profile when none specified

PASS src/embedding-models/__tests__/registry.test.ts
  Embedding Model Registry
    ✓ should validate Cohere embedding model IDs (1 ms)
    ✓ should return metadata for valid embedding models
    ✓ should return undefined for invalid model IDs (1 ms)
    ✓ should list all embedding models

PASS src/speech-models/__tests__/registry.test.ts
  Speech Model Registry
    ✓ should validate OCI TTS model IDs (1 ms)
    ✓ should return metadata for TTS_2_NATURAL (1 ms)
    ✓ should return metadata for TTS_1_STANDARD
    ✓ should return undefined for invalid model IDs
    ✓ should list all speech models (1 ms)
    ✓ should include supported languages for TTS_2_NATURAL
    ✓ should include supported languages for TTS_1_STANDARD
    ✓ should not have requiredRegion constraint

PASS src/reranking-models/__tests__/registry.test.ts
  Reranking Model Registry
    ✓ should validate Cohere reranking model IDs (1 ms)
    ✓ should return metadata for valid reranking models
    ✓ should return undefined for invalid model IDs (1 ms)
    ✓ should list all reranking models

PASS src/transcription-models/__tests__/registry.test.ts
  Transcription Model Registry
    ✓ should validate transcription model IDs (1 ms)
    ✓ should return metadata for valid transcription models
    ✓ should return metadata for WHISPER_MEDIUM (1 ms)
    ✓ should return metadata for WHISPER_LARGE_V2
    ✓ should return undefined for invalid model IDs (1 ms)
    ✓ should list all transcription models
    ✓ should return Oracle languages (locale-specific) (1 ms)
    ✓ should return Whisper languages (locale-agnostic)
    ✓ should indicate Whisper supports more languages
    ✓ should indicate Oracle supports custom vocabulary (1 ms)

PASS src/shared/__tests__/oci-sdk-types.test.ts
  OCI SDK Types
    OCIReasoningEffort
      ✓ should accept valid reasoning effort values (1 ms)
    OCIThinkingType
      ✓ should accept ENABLED and DISABLED
    OCIApiFormat
      ✓ should accept valid API formats
    OCICompletionTokensDetails
      ✓ should have optional fields (1 ms)
      ✓ should accept all token detail fields
    toOCIReasoningEffort
      ✓ should convert lowercase to uppercase
      ✓ should return MEDIUM for invalid values (1 ms)
    createThinkingConfig
      ✓ should create ENABLED config when true
      ✓ should create DISABLED config when false
    isValidApiFormat
      ✓ should return true for valid formats
      ✓ should return false for invalid formats

PASS src/__tests__/coverage.test.ts
  Coverage Configuration
    ✓ should enforce 80% coverage threshold
    ✓ should collect coverage from all source files (1 ms)

PASS src/__tests__/e2e/full-workflow.e2e.test.ts
  E2E: Complete Workflows
    ✓ should support complete RAG workflow (1 ms)
    ✓ should support multimodal workflow
    ✓ should handle errors gracefully across model types

Test Suites: 43 passed, 43 total
Tests:       727 passed, 727 total
Snapshots:   0 total
Time:        19.516 s
Ran all test suites.
