
> @acedergren/oci-genai-provider@0.1.0 test /Users/acedergr/Projects/oci-genai-provider/packages/oci-genai-provider
> jest

PASS src/realtime/__tests__/OCIRealtimeTranscription.test.ts (11.93 s)
  OCIRealtimeTranscription
    constructor
      ✓ should create session with config (7 ms)
      ✓ should merge config and settings (3 ms)
    connect()
      ✓ should connect to realtime service (698 ms)
      ✓ should emit connected event (629 ms)
      ✓ should support override settings (630 ms)
    event-based API
      ✓ should emit partial events (628 ms)
      ✓ should emit final events (626 ms)
      ✓ should emit result event for final results (629 ms)
      ✓ should support chained on() calls (1 ms)
      ✓ should support off() for removing listeners (627 ms)
    sendAudio()
      ✓ should send audio data (624 ms)
      ✓ should track audio duration (627 ms)
      ✓ should throw if not connected (11 ms)
    async iterator API
      ✓ should implement AsyncIterable (1 ms)
      ✓ should yield results via for-await-of (37 ms)
    sessionInfo
      ✓ should provide session information (628 ms)
      ✓ should track result count (627 ms)
    close()
      ✓ should close connection (629 ms)
      ✓ should emit disconnected event (628 ms)
    normalized results
      ✓ should normalize OCI result format (628 ms)
      ✓ should include token information (629 ms)

PASS src/language-models/converters/__tests__/cohere-messages.test.ts
  convertToCohereFormat
    basic message conversion
      ✓ should convert simple user message (2 ms)
      ✓ should extract system message as preambleOverride (1 ms)
      ✓ should convert chat history correctly (2 ms)
    tool call handling
      ✓ should include toolCalls in chatHistory for assistant messages with tool calls (1 ms)
      ✓ should extract toolResults from TOOL messages (1 ms)
      ✓ should handle multiple tool calls and results (1 ms)
      ✓ should set hasToolResults flag when tool results are present (1 ms)
      ✓ should not set hasToolResults when no tool results present (1 ms)
    edge cases
      ✓ should handle assistant message with tool calls but no text (1 ms)
      ✓ should handle tool call with empty arguments
      ✓ should throw error if no messages provided (10 ms)
      ✓ should throw error if no USER message present (1 ms)

PASS src/language-models/__tests__/OCILanguageModel.test.ts
  OCILanguageModel
    Authentication
      ✓ should initialize client with proper auth provider lazily (10 ms)
      ✓ should reuse client across multiple calls (2 ms)
      ✓ should throw helpful error if auth provider creation fails (11 ms)
    Construction
      ✓ should create model with valid model ID (1 ms)
      ✓ should throw error for invalid model ID (2 ms)
      ✓ should have correct specification version
      ✓ should have correct provider identifier (1 ms)
      ✓ should have tool default object generation mode (1 ms)
    doGenerate
      ✓ should return content from response (1 ms)
      ✓ should return usage statistics (2 ms)
      ✓ should include stringified messages in request body for observability (2 ms)
    Compartment ID validation
      ✓ should throw error when compartmentId is missing (1 ms)
      ✓ should use compartmentId from config when provided (1 ms)
    Error handling
      ✓ should wrap 401 errors with APICallError and authentication context (1 ms)
      ✓ should wrap 429 errors with retryable flag (723 ms)
      ✓ should wrap streaming errors with APICallError (714 ms)

PASS src/realtime/__tests__/OCIRealtimeClient.test.ts
  OCIRealtimeClient
    constructor
      ✓ should create client with config (3 ms)
    connect()
      ✓ should connect to realtime service (127 ms)
      ✓ should emit state changes during connection (125 ms)
      ✓ should emit authenticated event with session ID (125 ms)
      ✓ should throw error if already connected (141 ms)
      ✓ should throw error if compartmentId is missing (2 ms)
      ✓ should connect to correct regional endpoint (125 ms)
    sendAudio()
      ✓ should send audio data to WebSocket (129 ms)
      ✓ should throw error if not connected (5 ms)
    message handling
      ✓ should emit RESULT messages (144 ms)
      ✓ should emit error for ERROR messages (126 ms)
    close()
      ✓ should close connection (125 ms)
      ✓ should emit closed event (125 ms)
    event handling
      ✓ should support on/off pattern (126 ms)

PASS src/language-models/__tests__/OCILanguageModel.cohere-tools.test.ts
  OCILanguageModel - Cohere Tool Calling
    COHERE format with tool results
      ✓ should set isForceSingleStep=true when tool results are present (5 ms)
      ✓ should NOT set isForceSingleStep when no tool results present (1 ms)
      ✓ should include toolCalls in chatHistory for assistant messages (2 ms)
      ✓ should handle multiple tool calls and results (2 ms)

PASS src/__tests__/e2e-workflows.test.ts
  E2E Workflows
    RAG Pipeline
      RAG: Embed → Rerank → Generate
        ✓ should complete full RAG workflow with embeddings, reranking, and generation (4 ms)
        ✓ should handle document corpus embedding in RAG workflow (4 ms)
        ✓ should rerank retrieved documents based on query relevance (1 ms)
        ✓ should generate response using top reranked documents (4 ms)
        ✓ should pipeline models with config sharing across RAG workflow (2 ms)
      RAG Edge Cases
        ✓ should handle empty document corpus (2 ms)
        ✓ should handle large document corpus efficiently (2 ms)
        ✓ should handle multilingual documents in RAG (2 ms)
    Multimodal Pipeline
      Multimodal: Speech → Transcription → Generation
        ✓ should complete speech synthesis workflow (4 ms)
        ✓ should complete transcription workflow (2 ms)
        ✓ should handle full speech-to-text-to-speech loop (2 ms)
        ✓ should handle multimodal response generation with text and audio (2 ms)
        ✓ should maintain context across multimodal transformations (3 ms)
      Multimodal Edge Cases
        ✓ should handle audio with different sample rates (3 ms)
        ✓ should handle multilingual speech synthesis (1 ms)
        ✓ should handle very long audio for transcription (8 ms)
    Error Handling Pipeline
      Graceful Error Handling Across Model Types
        ✓ should handle rate limit errors gracefully (4 ms)
        ✓ should handle authentication errors across provider (1 ms)
        ✓ should handle service unavailable errors (4 ms)
        ✓ should handle model not found errors (3 ms)
        ✓ should provide error context across model types (3 ms)
      Error Recovery and Retry Logic
        ✓ should support retry mechanism for transient errors (1 ms)
        ✓ should handle circuit breaker pattern for repeated failures (1 ms)
        ✓ should handle degraded service mode (3 ms)
      Error Propagation and Logging
        ✓ should provide detailed error information for debugging (2 ms)
        ✓ should handle error correlation across service calls (2 ms)
      Error Scenarios in Complex Workflows
        ✓ should recover from error in RAG pipeline embedding step (1 ms)
        ✓ should handle error in multimodal pipeline transcription step (2 ms)
        ✓ should provide partial results on partial pipeline failure (3 ms)
    Workflow Integration Tests
      ✓ should create all model types successfully in single workflow (2 ms)
      ✓ should merge provider config with model-specific settings in workflows (1 ms)
      ✓ should handle optional model methods correctly (2 ms)
      ✓ should throw NoSuchModelError for imageModel (43 ms)
    Performance and Scale Considerations
      ✓ should handle concurrent model creation (2 ms)
      ✓ should reuse provider instances across workflows (4 ms)
      ✓ should handle rapid sequential model creation (3 ms)

PASS src/realtime/__tests__/WebSocketAdapter.test.ts
  WebSocketAdapter
    constructor
      ✓ should create a WebSocket connection (28 ms)
      ✓ should accept connection options (24 ms)
    readyState
      ✓ should report CONNECTING initially (1 ms)
      ✓ should report OPEN after connection (23 ms)
      ✓ should report CLOSED after close (26 ms)
    convenience properties
      ✓ should have isConnecting property (2 ms)
      ✓ should have isOpen property (25 ms)
      ✓ should have isClosed property (4 ms)
    event handling
      ✓ should emit open event when connected (25 ms)
      ✓ should emit close event when closed (24 ms)
      ✓ should emit message event when receiving data (25 ms)
      ✓ should emit error event on WebSocket error (26 ms)
      ✓ should support removing event listeners (24 ms)
    send()
      ✓ should send string data (23 ms)
      ✓ should send ArrayBuffer data (25 ms)
      ✓ should send Uint8Array data (25 ms)
      ✓ should throw error if not connected (16 ms)
    close()
      ✓ should close with default code and reason (26 ms)
      ✓ should close with custom code and reason (23 ms)
      ✓ should be safe to call multiple times (24 ms)
  WebSocketReadyState
    ✓ should have correct values (2 ms)

PASS src/shared/schemas/__tests__/provider-options.test.ts
  OCIProviderOptionsSchema
    valid options
      ✓ should accept empty options (3 ms)
      ✓ should accept valid reasoningEffort values (1 ms)
      ✓ should accept thinking with tokenBudget (2 ms)
      ✓ should accept valid servingMode object (1 ms)
      ✓ should accept dedicated servingMode with endpointId (1 ms)
      ✓ should accept valid endpoint URL (1 ms)
      ✓ should accept compartmentId (1 ms)
      ✓ should accept requestOptions (1 ms)
    invalid options
      ✓ should reject invalid reasoningEffort (2 ms)
      ✓ should reject negative tokenBudget (1 ms)
      ✓ should reject zero tokenBudget (1 ms)
      ✓ should reject non-integer tokenBudget (1 ms)
      ✓ should reject invalid servingMode type (2 ms)
      ✓ should reject servingMode as string (1 ms)
      ✓ should reject invalid endpoint URL (1 ms)
      ✓ should reject invalid requestOptions.timeoutMs (1 ms)
    discriminated union for servingMode
      ✓ should require modelId for ON_DEMAND serving mode (1 ms)
      ✓ should require endpointId for DEDICATED serving mode (2 ms)
      ✓ should accept ON_DEMAND with modelId (2 ms)
      ✓ should accept DEDICATED with endpointId (1 ms)
    strict mode - unknown keys rejected
      ✓ should reject unknown top-level keys (1 ms)
      ✓ should reject unknown keys in requestOptions (2 ms)
      ✓ should reject unknown keys in retry config (1 ms)
    cross-field validation
      ✓ should reject tokenBudget without thinking enabled (2 ms)
      ✓ should reject tokenBudget when thinking is false (1 ms)
      ✓ should accept tokenBudget when thinking is true (1 ms)
      ✓ should accept thinking without tokenBudget (1 ms)
    parseProviderOptions helper
      ✓ should return validated options (1 ms)
      ✓ should throw OCIValidationError for invalid options (9 ms)
      ✓ should include error details in OCIValidationError (2 ms)
      ✓ should handle undefined gracefully (1 ms)
      ✓ should handle null gracefully (1 ms)
      ✓ should validate nested requestOptions (2 ms)
    type inference
      ✓ should correctly infer types from schema (1 ms)
      ✓ should narrow servingMode type based on discriminator (1 ms)

PASS src/__tests__/provider.test.ts
  createOCI Provider Factory (ProviderV3)
    Factory Creation
      ✓ should create provider with default config (3 ms)
      ✓ should create provider with Frankfurt region (2 ms)
      ✓ should create provider with custom profile (1 ms)
      ✓ should create provider with compartment ID (3 ms)
      ✓ should create provider with instance principal auth (2 ms)
    Model Creation via languageModel()
      ✓ should create language model instance (2 ms)
      ✓ should create Grok model (2 ms)
      ✓ should create Llama model (1 ms)
      ✓ should create Cohere model (1 ms)
      ✓ should create Gemini model (1 ms)
      ✓ should throw error for invalid model ID (19 ms)
    Configuration Cascade
      ✓ should prioritize config over environment (2 ms)
      ✓ should use environment when config not provided (1 ms)
      ✓ should use Frankfurt as final default (1 ms)
    oci default instance
      ✓ should export default provider instance (1 ms)
      ✓ should create language models from default instance
  OCIGenAIProvider (ProviderV3)
    specificationVersion
      ✓ should have specificationVersion V3 (2 ms)
    languageModel()
      ✓ should create language model with model ID (3 ms)
      ✓ should pass config to language models (1 ms)
      ✓ should merge provider config with model-specific settings (1 ms)
      ✓ should throw error for invalid model ID (1 ms)
    embeddingModel()
      ✓ should create embedding model instance (10 ms)
      ✓ should create different embedding models (3 ms)
      ✓ should merge provider config with embedding-specific settings (2 ms)
      ✓ should throw error for invalid embedding model ID (6 ms)
    imageModel()
      ✓ should throw NoSuchModelError - OCI does not support image generation (3 ms)
      ✓ should include helpful message about OCI limitations (2 ms)
    transcriptionModel()
      ✓ should create transcription model with valid ID (3 ms)
      ✓ should create Oracle transcription model (1 ms)
      ✓ should throw error for invalid model ID (12 ms)
    speechModel()
      ✓ should create speech model with valid ID (3 ms)
      ✓ should create TTS_1_STANDARD model (1 ms)
      ✓ should throw error for invalid model ID (6 ms)
    rerankingModel()
      ✓ should create reranking model (2 ms)
      ✓ should merge config with reranking-specific settings (2 ms)
      ✓ should throw for invalid reranking model ID (5 ms)
    Integration Tests
      ✓ should create all model types successfully (19 ms)
      ✓ should merge provider config with model-specific settings (2 ms)
      ✓ should merge embedding config with model-specific settings (3 ms)
      ✓ should merge reranking config with model-specific settings (1 ms)
      ✓ should throw NoSuchModelError for imageModel (1 ms)
      ✓ should include helpful error message for imageModel (1 ms)
      ✓ should have all optional provider methods defined (2 ms)
      ✓ should preserve provider config across multiple model creations (2 ms)
      ✓ should allow region override in speech model creation (2 ms)
      ✓ should allow region override in transcription model creation (2 ms)
      ✓ should support config merging for all model types with requestOptions (2 ms)
      ✓ should create speech model with voice configuration override (1 ms)
      ✓ should handle empty provider config (2 ms)
      ✓ should throw for invalid language model ID format (2 ms)
      ✓ should throw for invalid embedding model ID format (2 ms)
      ✓ should throw for invalid speech model ID format (1 ms)
      ✓ should throw for invalid transcription model ID format (2 ms)
      ✓ should throw for invalid reranking model ID format (2 ms)
    realtimeTranscription()
      ✓ should create realtime transcription session (3 ms)
      ✓ should accept realtime-specific settings (1 ms)
      ✓ should merge provider config with realtime settings (1 ms)
      ✓ should implement AsyncIterable (2 ms)

PASS src/__tests__/utils/__tests__/test-helpers.test.ts
  Test Helpers
    createMockOCIConfig
      ✓ should create valid mock config with defaults (2 ms)
      ✓ should allow overrides (1 ms)
    createMockOCIResponse
      ✓ should create mock language model response (1 ms)
      ✓ should create mock embedding response (1 ms)
    mockOCIError
      ✓ should create mock rate limit error (1 ms)
      ✓ should create mock authentication error (1 ms)
    waitForCondition
      ✓ should resolve when condition becomes true (105 ms)
      ✓ should timeout if condition never becomes true (108 ms)

PASS src/shared/schemas/__tests__/provider-settings.test.ts
  CompartmentIdSchema
    ✓ ZOD-001: accepts valid compartment OCID (1 ms)
    ✓ ZOD-002: rejects invalid compartment OCID format
    ✓ ZOD-003: rejects empty string (1 ms)
  RegionSchema
    ✓ ZOD-004: accepts valid region format (1 ms)
    ✓ ZOD-005: rejects invalid region format
    ✓ ZOD-006: rejects AWS-style region format (1 ms)
  ServingModeSchema
    ✓ ZOD-007: accepts on-demand mode (1 ms)
    ✓ ZOD-008: accepts dedicated mode (1 ms)
    ✓ ZOD-009: rejects invalid mode (1 ms)
    ✓ ZOD-010: defaults to on-demand when parsing undefined (4 ms)
  EndpointIdSchema
    ✓ ZOD-011: accepts valid endpoint OCID (1 ms)
    ✓ ZOD-012: rejects non-OCID endpoint (2 ms)
  OCIProviderSettingsSchema
    ✓ ZOD-013: accepts valid on-demand settings (1 ms)
    ✓ ZOD-014: accepts valid dedicated settings with endpointId (2 ms)
    ✓ ZOD-015: rejects dedicated mode without endpointId (1 ms)
    ✓ ZOD-016: accepts empty settings object (1 ms)
    ✓ ZOD-017: accepts settings with only configProfile
  validateProviderSettings
    ✓ ZOD-018: returns success for valid settings (1 ms)
    ✓ ZOD-019: returns error for invalid settings
  parseProviderSettings
    ✓ ZOD-020: throws OCIValidationError for invalid settings (23 ms)
    ✓ ZOD-021: returns parsed settings for valid input (1 ms)
    ✓ ZOD-026: includes validation issues in OCIValidationError (1 ms)
    ✓ ZOD-027: error message includes field path (2 ms)
  OcidSchema
    ✓ ZOD-028: accepts valid generic OCID (1 ms)
    ✓ ZOD-029: rejects invalid OCID format
  ModelIdSchema
    ✓ ZOD-022: accepts non-empty model ID (1 ms)
    ✓ ZOD-023: rejects empty model ID (1 ms)
  OCIChatModelIdSchema
    ✓ ZOD-024: accepts simple model ID object (2 ms)
    ✓ ZOD-025: accepts dedicated endpoint model ID

PASS src/__tests__/regression.test.ts
  Regression: Provider Configuration
    ✓ REG-001: Provider must accept compartmentId from environment (3 ms)
    ✓ REG-002: Provider must accept region configuration (1 ms)
    ✓ REG-003: Provider must accept explicit config options (1 ms)
    ✓ REG-004: Provider must create valid language model (1 ms)
    ✓ REG-005-008: Provider must support cohere.command-r-plus model family (2 ms)
    ✓ REG-005-008: Provider must support google.gemini-2.5-pro model family (2 ms)
    ✓ REG-005-008: Provider must support xai.grok-4 model family (1 ms)
    ✓ REG-005-008: Provider must support meta.llama-3.3-70b-instruct model family (1 ms)
  Regression: Model Creation & Error Handling
    ✓ REG-009: languageModel() must return LanguageModelV3 interface (1 ms)
    ✓ REG-010: Provider name must be oci-genai
    ✓ REG-011: chat() must be alias for languageModel() (1 ms)
    ✓ REG-012: Invalid model ID should throw NoSuchModelError (15 ms)
    ✓ REG-013: Empty model ID should throw (1 ms)
    ✓ REG-014: imageModel() should throw (not supported) (1 ms)
  Regression: Model Registry
    ✓ REG-015: isValidModelId(cohere.command-r-plus) must return true
    ✓ REG-015: isValidModelId(meta.llama-3.3-70b-instruct) must return true (1 ms)
    ✓ REG-015: isValidModelId(xai.grok-4) must return true
    ✓ REG-015: isValidModelId(google.gemini-2.5-pro) must return true
    ✓ REG-016: isValidModelId(unknown.model) must return false (1 ms)
    ✓ REG-016: isValidModelId(future.new-model) must return false
    ✓ REG-016: isValidModelId() must return false
    ✓ REG-017: getModelMetadata must return info for known models
    ✓ REG-018: getModelMetadata must return undefined for unknown models (1 ms)
    ✓ REG-019: getAllModels must return non-empty array with all families
    ✓ REG-021: getModelsByFamily(cohere) must filter correctly (1 ms)
    ✓ REG-021: getModelsByFamily(grok) must filter correctly
  Regression: Provider Specification
    ✓ REG-022: Default oci export must be valid provider (1 ms)
    ✓ REG-023: Provider must expose models catalog
  Regression: Serving Mode Configuration
    ✓ REG-024: Provider must accept on-demand serving mode (1 ms)
    ✓ REG-025: Provider must accept dedicated serving mode with endpointId (1 ms)
    ✓ REG-026: Provider must accept endpointId from environment

PASS src/language-models/__tests__/OCILanguageModel-retry.test.ts
  OCILanguageModel Retry and Timeout Integration
    Retry behavior
      ✓ should retry on transient 500 errors and eventually succeed (20 ms)
      ✓ should retry on 429 rate limit errors (5 ms)
      ✓ should retry on network errors (ECONNRESET) (4 ms)
      ✓ should NOT retry on 401 authentication errors (14 ms)
      ✓ should NOT retry on 400 bad request errors (3 ms)
      ✓ should exhaust retries and throw final error (8 ms)
      ✓ should respect retry.enabled = false (2 ms)
    Timeout behavior
      ✓ should timeout on slow requests (16 ms)
      ✓ should succeed if request completes within timeout (2 ms)
    Configuration options
      ✓ should use default options when none provided (3 ms)
      ✓ should merge config options with defaults (2 ms)
      ✓ should allow custom timeout values (3 ms)
    Streaming with retry
      ✓ should retry connection establishment for streaming (4 ms)
    Error handling integration
      ✓ should wrap errors with APICallError after retry exhaustion (5 ms)
      ✓ should preserve original error message after retries (3 ms)

PASS src/language-models/__tests__/registry.test.ts
  Model Registry
    isValidModelId
      ✓ should reject completely invalid model ID
      Grok models
        ✓ should validate xai.grok-code-fast-1 (1 ms)
        ✓ should validate xai.grok-4-1-fast-reasoning (1 ms)
        ✓ should validate xai.grok-4-1-fast-non-reasoning (1 ms)
        ✓ should validate xai.grok-4-fast-reasoning
        ✓ should validate xai.grok-4-fast-non-reasoning
        ✓ should validate xai.grok-3 (1 ms)
        ✓ should validate xai.grok-3-mini (1 ms)
        ✓ should reject invalid Grok model
      Llama models
        ✓ should validate meta.llama-3.3-70b-instruct (1 ms)
        ✓ should validate meta.llama-3.2-90b-vision-instruct (1 ms)
        ✓ should validate meta.llama-3.1-405b-instruct (1 ms)
      Cohere models
        ✓ should validate cohere.command-r-plus (1 ms)
        ✓ should validate cohere.command-plus-latest (1 ms)
        ✓ should validate cohere.command-latest
        ✓ should validate cohere.command-a-03-2025 (1 ms)
        ✓ should validate cohere.command-a-reasoning
        ✓ should validate cohere.command-a-vision (1 ms)
      Gemini models
        ✓ should validate google.gemini-2.5-pro (2 ms)
        ✓ should validate google.gemini-2.5-flash
        ✓ should validate google.gemini-2.5-flash-lite (1 ms)
    getModelMetadata
      ✓ should return Grok Code Fast metadata (1 ms)
      ✓ should return Gemini Flash with vision capability
      ✓ should return Llama Vision metadata (1 ms)
      ✓ should return undefined for invalid model (1 ms)
      ✓ should include all required metadata fields (1 ms)
    getAllModels
      ✓ should return all models (16+ models) (1 ms)
      ✓ should include models from all families (1 ms)
    getModelsByFamily
      ✓ should return Grok models (1 ms)
      ✓ should return Llama models
      ✓ should return Cohere models (1 ms)
      ✓ should return Gemini models (1 ms)
      ✓ should return empty array for unknown family
    supportsReasoning
      ✓ should return false for invalid model ID (1 ms)
      reasoning-capable models
        ✓ should return false for xai.grok-4-1-fast-reasoning (no API support) (1 ms)
        ✓ should return false for xai.grok-4-fast-reasoning (no API support)
        ✓ should return true for cohere.command-a-reasoning-08-2025 (1 ms)
        ✓ should return true for cohere.command-a-reasoning
      non-reasoning models
        ✓ should return false for meta.llama-3.3-70b-instruct (1 ms)
        ✓ should return false for cohere.command-r-plus (2 ms)
        ✓ should return true for google.gemini-2.5-flash (supports reasoning) (11 ms)
        ✓ should return false for xai.grok-4-1-fast-non-reasoning (1 ms)

PASS src/shared/streaming/__tests__/sse-parser.test.ts
  SSE Parser
    mapFinishReason
      ✓ should map STOP to stop (1 ms)
      ✓ should map LENGTH to length (2 ms)
      ✓ should map CONTENT_FILTER to content-filter (1 ms)
      ✓ should map unknown to other (1 ms)
      ✓ should map empty string to other (1 ms)
    SSE data format
      ✓ should recognize text delta event structure (1 ms)
      ✓ should recognize finish event structure (1 ms)
      ✓ should yield text-delta parts (1 ms)
      ✓ should yield finish part with usage (1 ms)
    SSE parsing edge cases
      ✓ should handle done event marker (1 ms)
      ✓ should handle malformed JSON gracefully (1 ms)
      ✓ should handle empty events (1 ms)
    Performance
      ✓ should parse 1000 events in under 100ms (14 ms)
    parseSSEStream
      ✓ should parse text delta from stream (2 ms)
      ✓ should parse finish event from stream (2 ms)
      ✓ should handle empty event data (1 ms)
      ✓ should handle error event parsing (1 ms)
      ✓ should handle malformed JSON in events gracefully (1 ms)
      ✓ should handle multiple consecutive newlines (1 ms)
      ✓ should handle mixed line endings (CRLF vs LF) (1 ms)
      ✓ should throw when response body is not readable (14 ms)
      ✓ should yield remaining parts after stream completes (2 ms)
      ✓ should handle large chunked streams with buffered parts (2 ms)
      ✓ should handle events with whitespace in data fields (1 ms)
      ✓ should handle [DONE] marker correctly
      ✓ should parse GENERIC format tool calls from stream (1 ms)
      ✓ should parse COHERE format tool calls from stream (1 ms)
      ✓ should parse multiple tool calls from stream (2 ms)
      ✓ should parse text followed by tool calls (1 ms)
      ✓ should parse finish event with prediction token details (2 ms)
      ✓ should handle finish event without prediction token details (2 ms)
      ✓ should handle partial prediction token details

PASS src/language-models/__tests__/OCILanguageModel.advanced.test.ts
  OCILanguageModel - Advanced V3 Features
    Vision (Multimodal)
      ✓ should convert file parts (images) to OCI format for Generic models (5 ms)
      ✓ should convert file parts (images) to OCI format for Cohere V2 models (2 ms)
    Reasoning
      ✓ should support reasoning settings for Generic models (3 ms)
      ✓ should support reasoning settings for Cohere models (2 ms)
      ✓ should stream reasoning deltas (2 ms)

PASS src/language-models/converters/__tests__/messages.test.ts
  Message Conversion
    convertToOCIMessages
      ✓ should convert simple user message (2 ms)
      ✓ should convert system message (2 ms)
      ✓ should convert assistant message
      ✓ should convert multi-turn conversation (1 ms)
      ✓ should handle string content format
      ✓ should handle array content format (1 ms)
      ✓ should handle empty content (1 ms)
      ✓ should filter out non-text content parts (1 ms)
      ✓ should handle image content type (via file type) (1 ms)
      ✓ should handle file content type (non-text branch) (1 ms)
      ✓ should handle image content type (non-text branch) (1 ms)
      ✓ should handle file content type (non-text branch)
      ✓ should handle mixed text and image content types (1 ms)
      ✓ should handle mixed text, image, and file content types (1 ms)
      ✓ should handle assistant message with non-text content
      ✓ should handle user message with only non-text content
      ✓ should handle content that is not string or array (edge case for branch coverage) (1 ms)
      ✓ should throw error for unsupported role (10 ms)
    Tool Parts
      ✓ should convert assistant message with tool-call part (1 ms)
      ✓ should convert assistant message with string input in tool-call (1 ms)
      ✓ should convert assistant message with text and tool-call parts
      ✓ should convert tool message with tool-result part (1 ms)
      ✓ should convert multiple tool calls in one message (1 ms)
      ✓ should handle undefined input in tool-call
    Performance
      ✓ should convert messages with 100 parts in under 5ms (1 ms)

PASS src/language-models/__tests__/OCILanguageModel.stream.test.ts
  OCILanguageModel.doStream
    ✓ should return stream result with stream property (5 ms)
    ✓ should stream text deltas (3 ms)
    ✓ should include finish part with usage (1 ms)
    ✓ should include raw parts when includeRawChunks is true
    ✓ should set isStream flag in request
    ✓ should include temperature in streaming request (1 ms)
    ✓ should include maxTokens in streaming request

PASS src/language-models/__tests__/seed-parameter.test.ts
  OCILanguageModel - seed parameter
    ✓ should pass seed parameter in non-streaming requests (5 ms)
    ✓ should pass seed parameter in streaming requests (2 ms)
    ✓ should not include seed parameter when not provided (2 ms)

PASS src/language-models/converters/__tests__/tools.test.ts
  Tool Converters
    convertToOCITools
      ✓ should convert AI SDK function tools to OCI GENERIC format (3 ms)
      ✓ should convert AI SDK function tools to OCI COHERE format (16 ms)
      ✓ should handle tools with no properties (2 ms)
      ✓ should handle tools with no description (2 ms)
    convertToOCIToolChoice
      ✓ should convert auto tool choice (1 ms)
      ✓ should convert required tool choice (1 ms)
      ✓ should convert none tool choice
      ✓ should convert tool-specific choice
    convertFromOCIToolCalls
      ✓ should convert OCI GENERIC format tool calls to AI SDK format
      ✓ should convert OCI COHERE format tool calls to AI SDK format (1 ms)
      ✓ should handle invalid JSON in arguments gracefully (1 ms)
      ✓ should handle multiple tool calls (1 ms)
    supportsToolCalling
      ✓ should return true for Llama 3.1+ models (2 ms)
      ✓ should return false for older Llama models (1 ms)
      ✓ should return true for Cohere Command R models (2 ms)
      ✓ should return false for older Cohere models (6 ms)
      ✓ should return true for Grok models (2 ms)
      ✓ should return true for Gemini models (1 ms)
      ✓ should return false for unknown models (1 ms)

PASS src/transcription-models/__tests__/OCITranscriptionModel.test.ts
  OCITranscriptionModel
    ✓ should have correct specification version and provider (2 ms)
    ✓ should accept WHISPER_MEDIUM model ID (3 ms)
    ✓ should accept WHISPER_LARGE_V2 model ID (1 ms)
    ✓ should throw error for invalid model ID (16 ms)
    ✓ should reject old-style model IDs (1 ms)
    ✓ should accept language setting (1 ms)
    ✓ should accept custom vocabulary for Oracle model
    ✓ should warn about vocabulary for Whisper model (1 ms)
    audio validation
      ✓ should throw error when audio exceeds 2GB limit (2 ms)
      ✓ should accept audio under 2GB limit (2 ms)
    response structure
      ✓ should return all required TranscriptionOutput properties (2 ms)
      ✓ should include providerMetadata with jobId (1 ms)
    warnings
      ✓ should add warning when using vocabulary with Whisper model (1 ms)
      ✓ should have empty warnings when vocabulary not used (1 ms)
    language handling
      ✓ should return configured language (2 ms)
      ✓ should return undefined when language not configured (2 ms)
    Object Storage integration
      ✓ should use custom bucket when configured (2 ms)
      ✓ should cleanup uploaded file after transcription (1 ms)
    base64 audio input
      ✓ should accept base64-encoded audio string (1 ms)
    custom endpoint
      ✓ should set endpoint on client when configured (1 ms)
    error paths
      ✓ should throw wrapped error when upload fails (1 ms)
      ✓ should throw when no transcription tasks found in job (2 ms)
      ✓ should throw wrapped error when getting task details fails (1 ms)
      ✓ should use fallback output filename when task has no outputLocation (1 ms)
      ✓ should throw wrapped error when download result fails (1 ms)
      ✓ should throw when transcription job enters FAILED state (1 ms)
      ✓ should throw timeout after max poll attempts (67 ms)
      ✓ should silently ignore cleanup errors after transcription (2 ms)

PASS src/shared/utils/__tests__/retry.test.ts
  withRetry
    ✓ should return result on first success (2 ms)
    ✓ should not retry on 4xx client errors (13 ms)
    ✓ should use custom isRetryable function (3 ms)
    ✓ should retry on transient error and succeed (5 ms)
    ✓ should throw after max retries exceeded (9 ms)
    ✓ should retry on 5xx server errors (1 ms)
    ✓ should respect custom retry options (3 ms)
  withRetry exponential backoff
    ✓ should use exponential backoff (6 ms)
    ✓ should cap delay at maxDelayMs (11 ms)
  isRetryableError
    ✓ should return true for network errors
    ✓ should return true for ECONNREFUSED errors (1 ms)
    ✓ should return true for EAI_AGAIN DNS errors
    ✓ should return true for 5xx errors (1 ms)
    ✓ should return true for 500 Internal Server Error
    ✓ should return true for 502 Bad Gateway (1 ms)
    ✓ should return true for 429 rate limit (1 ms)
    ✓ should return false for 4xx client errors (1 ms)
    ✓ should return false for 400 Bad Request (1 ms)
    ✓ should return false for 401 Unauthorized
    ✓ should return false for 403 Forbidden
    ✓ should return false for non-retryable errors (1 ms)
    ✓ should return false for non-Error values
    ✓ should check statusCode property as fallback (1 ms)
    ✓ should check error code property (1 ms)
    ✓ should return true for fetch failed errors (2 ms)
    ✓ should return true for network error messages (1 ms)

PASS src/speech-models/__tests__/OCISpeechModel.test.ts
  OCISpeechModel
    ✓ should have correct specification version and provider (2 ms)
    ✓ should throw error for invalid model ID (12 ms)
    ✓ should reject old-style model IDs (1 ms)
    ✓ should allow any region (no Phoenix-only restriction) (1 ms)
    ✓ should validate text length does not exceed max (1 ms)
    Voice Selection
      ✓ should use config.voice when provided (highest priority) (1 ms)
      ✓ should fallback to metadata defaultVoice if config voice not provided (1 ms)
      ✓ should fallback to hardcoded default when no defaultVoice in registry (1 ms)
      ✓ should fallback to en-US-AriaNeural if both config and metadata voice are undefined (1 ms)
      ✓ should prefer config.voice over default (1 ms)
    doGenerate
      ✓ should generate audio successfully for valid text (7 ms)
      ✓ should return timestamp in response (3 ms)
      ✓ should include request body in response (3 ms)
      ✓ should include providerMetadata with voice and format (5 ms)
      ✓ should pass correct modelName to OCI SDK (3 ms)
    format mapping
      ✓ should default to mp3 format when not specified (3 ms)

PASS src/reranking-models/__tests__/OCIRerankingModel.test.ts
  OCIRerankingModel
    ✓ should have correct specification version and provider (1 ms)
    ✓ should throw error for invalid model ID (15 ms)
    getClient
      ✓ should initialize client with auth provider and region (5 ms)
      ✓ should set custom endpoint if provided (2 ms)
      ✓ should reuse existing client on subsequent calls (2 ms)
    document type validation
      ✓ should throw error for non-text documents (1 ms)
      ✓ should accept text documents (3 ms)
    document count validation
      ✓ should validate document count does not exceed max (1 ms)
      ✓ should accept maximum allowed documents (1 ms)
    doRerank
      ✓ should rerank documents successfully (2 ms)
      ✓ should call OCI API with correct parameters (1 ms)
      ✓ should use custom topN setting from config (1 ms)
      ✓ should pass topN from call options (1 ms)
      ✓ should use returnDocuments setting (maps to isEcho) (1 ms)
      ✓ should handle missing relevanceScore gracefully (2 ms)
      ✓ should handle missing index gracefully (1 ms)
      ✓ should handle API errors gracefully (4 ms)
      ✓ should handle empty document ranks (1 ms)
    edge cases
      ✓ should handle single document
      ✓ should handle empty query (1 ms)
      ✓ should handle very long query (1 ms)
      ✓ should handle text documents (1 ms)

PASS src/config/__tests__/oci-config.test.ts
  parseOCIConfig
    ✓ should parse a valid OCI config file (3 ms)
    ✓ should return found=false when config file does not exist (2 ms)
    ✓ should handle missing key files gracefully (1 ms)
    ✓ should handle comments and empty lines (1 ms)
    ✓ should handle custom config path (1 ms)
  expandPath
    ✓ should expand ~ to home directory (1 ms)
    ✓ should expand ~/subdir paths (1 ms)
    ✓ should leave absolute paths unchanged (1 ms)
    ✓ should leave relative paths unchanged (1 ms)
    ✓ should handle empty string (1 ms)
  hasOCIConfig
    ✓ should return true when config exists and has content (1 ms)
    ✓ should return false when config does not exist (1 ms)
    ✓ should return false when config is empty (2 ms)
    ✓ should return false when statSync throws (1 ms)
  getConfigPath
    ✓ should return default path when OCI_CONFIG_FILE not set (2 ms)
    ✓ should return OCI_CONFIG_FILE when set (1 ms)
    ✓ should expand ~ in OCI_CONFIG_FILE (4 ms)
  getProfile
    ✓ should return profile by name (2 ms)
    ✓ should return DEFAULT profile when no name specified (1 ms)
    ✓ should return undefined for non-existent profile (3 ms)
    ✓ should return undefined when config file not found (3 ms)

PASS src/embedding-models/__tests__/OCIEmbeddingModel.test.ts
  OCIEmbeddingModel
    ✓ should have correct specification version and provider (2 ms)
    ✓ should set maxEmbeddingsPerCall to 96 (1 ms)
    ✓ should throw error for invalid model ID (9 ms)
    ✓ should validate embeddings count does not exceed max (2 ms)
    getClient
      ✓ should initialize client with auth provider (3 ms)
      ✓ should reuse client on subsequent calls (1 ms)
      ✓ should set custom endpoint when provided (1 ms)
    doEmbed
      ✓ should generate embeddings successfully (2 ms)
      ✓ should call OCI API with correct parameters (2 ms)
      ✓ should use custom truncate setting (2 ms)
      ✓ should use custom inputType setting
      ✓ should handle API errors gracefully (1 ms)
      ✓ should calculate token usage based on text length (1 ms)
      ✓ should handle single embedding request (3 ms)
      ✓ should handle empty values array (2 ms)
    model validation
      ✓ should accept cohere.embed-english-v3.0 (1 ms)
      ✓ should accept cohere.embed-english-light-v3.0 (2 ms)
      ✓ should support parallel calls (1 ms)

PASS src/shared/storage/__tests__/object-storage.test.ts
  downloadTranscriptionResult
    ✓ should parse valid OCI Speech JSON format and return transcription result (3 ms)
    ✓ should handle missing transcription field gracefully (10 ms)
    ✓ should handle invalid JSON parsing (1 ms)
    ✓ should handle stream read errors (3 ms)
    ✓ should handle empty token arrays (1 ms)
    ✓ should group tokens into segments based on 1-second gap threshold (3 ms)
    ✓ should preserve token confidence in extracted data (1 ms)
    ✓ should handle missing optional metadata fields (1 ms)
    ✓ should skip tokens with missing required fields (1 ms)
  uploadAudioToObjectStorage
    ✓ should upload audio and return location details (1 ms)
  deleteFromObjectStorage
    ✓ should delete an object from Object Storage (1 ms)
  generateAudioObjectName
    ✓ should generate a name matching the audio-{timestamp}-{random}.wav pattern (1 ms)
    ✓ should generate unique names on successive calls

PASS src/shared/utils/__tests__/timeout.test.ts
  withTimeout
    ✓ should return result if function completes before timeout (16 ms)
    ✓ should throw TimeoutError if function exceeds timeout (9 ms)
    ✓ should include custom message in TimeoutError (2 ms)
    ✓ should clear timeout on successful completion (2 ms)
    ✓ should clear timeout on function error (2 ms)
    ✓ should propagate function errors, not timeout errors (1 ms)
    ✓ should handle zero timeout (immediate timeout) (1 ms)
  TimeoutError
    ✓ should be instanceof Error (1 ms)
    ✓ should have correct name
    ✓ should expose timeoutMs property (1 ms)
    ✓ should have descriptive message
    ✓ should include operation name in message (1 ms)

PASS src/shared/errors/__tests__/errors.test.ts
  OCIGenAIError
    ✓ should be instanceof Error (1 ms)
    ✓ should have correct name
    ✓ should preserve cause (1 ms)
    ✓ should have retryable property
  NetworkError
    ✓ should extend OCIGenAIError
    ✓ should have correct name (1 ms)
    ✓ should indicate retryable by default
    ✓ should expose error code
    ✓ should preserve cause (1 ms)
  RateLimitError
    ✓ should extend OCIGenAIError
    ✓ should have correct name
    ✓ should indicate retryable
    ✓ should expose retryAfter when provided
    ✓ should have undefined retryAfter when not provided (1 ms)
    ✓ should preserve cause (1 ms)
  AuthenticationError
    ✓ should extend OCIGenAIError
    ✓ should have correct name (1 ms)
    ✓ should not be retryable (1 ms)
    ✓ should expose authentication type (1 ms)
    ✓ should support instance_principal auth type (1 ms)
    ✓ should preserve cause (1 ms)
  ModelNotFoundError
    ✓ should extend OCIGenAIError (2 ms)
    ✓ should have correct name
    ✓ should not be retryable (1 ms)
    ✓ should expose model ID
    ✓ should have descriptive message (2 ms)
    ✓ should preserve cause

PASS src/auth/__tests__/auth.test.ts
  createAuthProvider
    ✓ should create config file auth provider by default (2 ms)
    ✓ should use custom profile when provided (2 ms)
    ✓ should create instance principal auth when specified (1 ms)
    ✓ should throw error for unsupported auth method (8 ms)
    ✓ should create resource principal auth when specified (1 ms)
    ✓ should use custom config path when provided (1 ms)
  getCompartmentId
    ✓ should return compartment ID from config (3 ms)
    ✓ should return compartment ID from environment when not in config (1 ms)
    ✓ should prioritize config over environment (3 ms)
    ✓ should throw error when no compartment ID available (3 ms)
  getRegion
    ✓ should return region from config
    ✓ should return region from environment when not in config (1 ms)
    ✓ should use Frankfurt as default (2 ms)
    ✓ should prioritize config over environment (2 ms)

PASS src/config/__tests__/validation.test.ts
  validateCredentials
    ✓ should return valid=true for working credentials (4 ms)
    ✓ should return valid=false for authentication failures (1 ms)
    ✓ should return valid=false for timeout errors (1 ms)
    ✓ should return valid=false for missing key file (1 ms)
    ✓ should handle generic errors gracefully (1 ms)
    ✓ should use DEFAULT profile when none specified (2 ms)

PASS src/__tests__/errors.test.ts
  Error Handling
    OCIGenAIError
      ✓ should create error with message (2 ms)
      ✓ should include status code (1 ms)
      ✓ should mark as retryable (1 ms)
      ✓ should mark as non-retryable by default
    isRetryableError
      ✓ should identify 429 as retryable
      ✓ should identify 500 as retryable (1 ms)
      ✓ should identify 503 as retryable
      ✓ should mark 400 as non-retryable (1 ms)
      ✓ should mark 401 as non-retryable (1 ms)
      ✓ should mark 403 as non-retryable
      ✓ should mark 404 as non-retryable (1 ms)
    handleOCIError
      ✓ should add auth context to 401 errors
      ✓ should add IAM context to 403 errors
      ✓ should add model context to 404 errors (1 ms)
      ✓ should add rate limit context to 429 errors
      ✓ should preserve original message (1 ms)
      ✓ should wrap non-OCI errors (1 ms)
    Error Integration
      ✓ should convert OCIGenAIError to APICallError
      ✓ should set retryable based on status code (1 ms)
      ✓ should preserve status code in wrapped error

PASS src/__tests__/docs-validation.test.ts
  Documentation Validation
    README completeness
      ✓ README should document all model types (2 ms)
      ✓ README should include installation instructions (1 ms)
      ✓ README should document authentication (1 ms)
      ✓ README should link to examples (2 ms)
      ✓ README should document regional availability (1 ms)
    API Reference Documentation
      ✓ should document all provider methods (1 ms)
      ✓ should document createOCI factory (1 ms)
    Configuration Guide
      ✓ should document configuration methods (1 ms)
    Migration Guide
      ✓ should document breaking changes (1 ms)
    Troubleshooting Guide
      ✓ should document common issues (1 ms)

PASS src/transcription-models/__tests__/registry.test.ts
  Transcription Model Registry
    ✓ should validate transcription model IDs (1 ms)
    ✓ should return metadata for valid transcription models
    ✓ should return metadata for WHISPER_MEDIUM (1 ms)
    ✓ should return metadata for WHISPER_LARGE_V2 (1 ms)
    ✓ should return undefined for invalid model IDs (1 ms)
    ✓ should list all transcription models (1 ms)
    ✓ should return Oracle languages (locale-specific) (1 ms)
    ✓ should return Whisper languages (locale-agnostic) (2 ms)
    ✓ should indicate Whisper supports more languages (1 ms)
    ✓ should indicate Oracle supports custom vocabulary (1 ms)

PASS src/shared/__tests__/oci-sdk-types.test.ts
  OCI SDK Types
    OCIReasoningEffort
      ✓ should accept valid reasoning effort values (1 ms)
    OCIThinkingType
      ✓ should accept ENABLED and DISABLED
    OCIApiFormat
      ✓ should accept valid API formats
    OCICompletionTokensDetails
      ✓ should have optional fields
      ✓ should accept all token detail fields
    toOCIReasoningEffort
      ✓ should convert lowercase to uppercase
      ✓ should return MEDIUM for invalid values (1 ms)
    createThinkingConfig
      ✓ should create ENABLED config when true (1 ms)
      ✓ should create DISABLED config when false (1 ms)
    isValidApiFormat
      ✓ should return true for valid formats (1 ms)
      ✓ should return false for invalid formats (1 ms)

PASS src/config/__tests__/discovery.test.ts
  discoverCompartments
    ✓ should discover compartments from OCI API (3 ms)
    ✓ should exclude root compartment when includeRoot=false (1 ms)
    ✓ should handle empty compartment list (1 ms)
    ✓ should include compartment descriptions (1 ms)
    ✓ should preserve lifecycle state (1 ms)
    ✓ should use DEFAULT profile when none specified

PASS src/__tests__/types.test.ts
  OCIConfig
    ✓ should allow optional region configuration (1 ms)
    ✓ should allow all authentication methods (1 ms)
  OCILanguageModelSettings
    ✓ should support all OCIConfig fields plus requestOptions (1 ms)
  OCIEmbeddingSettings
    ✓ should have embedding-specific options
    ✓ should accept 384 dimensions for light models (1 ms)
  OCISpeechSettings
    ✓ should have TTS-specific options
  OCITranscriptionSettings
    ✓ should have STT-specific options (1 ms)
  OCIRerankingSettings
    ✓ should have reranking-specific options (1 ms)

PASS src/__tests__/mocks/__tests__/oci-mocks.test.ts
  OCI Mocks
    mockGenerativeAiInferenceClient
      ✓ should create mock client with default responses (1 ms)
      ✓ should allow custom response setup (2 ms)
      ✓ should have chat method callable (1 ms)
    mockAuthProvider
      ✓ should create valid auth provider mock (4 ms)
    resetAllMocks
      ✓ should be callable without error (1 ms)

PASS src/speech-models/__tests__/registry.test.ts
  Speech Model Registry
    ✓ should validate OCI TTS model IDs (2 ms)
    ✓ should return metadata for TTS_2_NATURAL (1 ms)
    ✓ should return metadata for TTS_1_STANDARD (1 ms)
    ✓ should return undefined for invalid model IDs (1 ms)
    ✓ should list all speech models (1 ms)
    ✓ should include supported languages for TTS_2_NATURAL (1 ms)
    ✓ should include supported languages for TTS_1_STANDARD (1 ms)
    ✓ should not have requiredRegion constraint (1 ms)

PASS src/reranking-models/__tests__/registry.test.ts
  Reranking Model Registry
    ✓ should validate Cohere reranking model IDs (2 ms)
    ✓ should return metadata for valid reranking models (3 ms)
    ✓ should return undefined for invalid model IDs (2 ms)
    ✓ should list all reranking models (3 ms)

PASS src/__tests__/coverage.test.ts
  Coverage Configuration
    ✓ should enforce 80% coverage threshold (1 ms)
    ✓ should collect coverage from all source files (1 ms)

PASS src/embedding-models/__tests__/registry.test.ts
  Embedding Model Registry
    ✓ should validate Cohere embedding model IDs (1 ms)
    ✓ should return metadata for valid embedding models (1 ms)
    ✓ should return undefined for invalid model IDs (1 ms)
    ✓ should list all embedding models (1 ms)

PASS src/__tests__/e2e/full-workflow.e2e.test.ts
  E2E: Complete Workflows
    ✓ should support complete RAG workflow (1 ms)
    ✓ should support multimodal workflow (1 ms)
    ✓ should handle errors gracefully across model types

Test Suites: 43 passed, 43 total
Tests:       727 passed, 727 total
Snapshots:   0 total
Time:        22.432 s
Ran all test suites.
