# OCI GenAI Provider - Architecture & Security

> Architecture design, security best practices, and project conventions

This file contains architectural decisions, security guidelines, and development conventions.

## Info

- **Focus**: Architecture, security, and code quality
- **Audience**: Contributors and maintainers
- **Architecture**: pnpm workspace monorepo (3 packages)
- **Standards**: TypeScript 5.3, ESM modules, Vercel AI SDK v3
- **Testing**: 121 tests, 80%+ coverage, TDD workflow

## Monorepo Architecture

**Main Documentation**: /docs/architecture/README.md

**Workspace Structure**:
```
opencode-oci-genai/
├── packages/
│   ├── oci-genai-provider/          # @acedergren/oci-genai-provider
│   │   ├── src/
│   │   │   ├── index.ts             # Public API exports
│   │   │   ├── types.ts             # Type definitions
│   │   │   ├── auth/                # Authentication providers
│   │   │   ├── models/              # Registry & LanguageModelV3
│   │   │   │   ├── registry.ts      # Model catalog
│   │   │   │   └── oci-language-model.ts  # Model implementation
│   │   │   ├── converters/          # Message conversion
│   │   │   ├── streaming/           # SSE parsing
│   │   │   │   ├── types.ts         # Stream types
│   │   │   │   └── sse-parser.ts    # SSE → AsyncGenerator
│   │   │   └── errors/              # Error handling
│   │   ├── __tests__/               # 121 tests (14 files)
│   │   ├── package.json             # Published to npm
│   │   └── tsup.config.ts           # CJS + ESM builds
│   │
│   ├── opencode-integration/        # @acedergren/opencode-oci-genai
│   │   ├── src/
│   │   │   ├── index.ts             # Re-exports core + OpenCode utils
│   │   │   ├── types.ts             # OpenCode config types
│   │   │   ├── register.ts          # Provider registration
│   │   │   └── config.ts            # Config helpers
│   │   └── package.json             # Published to npm
│   │
│   └── test-utils/                  # @acedergren/test-utils (private)
│       ├── src/
│       │   ├── index.ts             # Test fixtures
│       │   ├── oci-common.ts        # Auth mocks
│       │   └── oci-generativeaiinference.ts  # GenAI mocks
│       └── package.json             # Not published
│
├── docs/                            # Documentation (35+ files)
│   ├── testing/                     # Testing guide
│   ├── plans/                       # Implementation plans
│   └── architecture/                # Architecture docs
├── pnpm-workspace.yaml              # Workspace definition
└── package.json                     # Workspace root
```

**Package Dependency Graph**:
```
@acedergren/opencode-oci-genai (OpenCode wrapper)
    └─ workspace:* → @acedergren/oci-genai-provider (core)
                         └─ devDependencies → @acedergren/test-utils (mocks)
```

## Design Decisions

**File**: /docs/architecture/design-decisions.md

**Key Architectural Choices**:

### 1. Provider Pattern
- Factory function `createOCI()` returns provider
- Supports multiple configurations
- Lazy model instantiation
- Thread-safe singleton pattern

```typescript
export function createOCI(config?: OCIConfig): OCIProvider {
  return {
    provider: 'oci-genai',
    model: (modelId: string) => new OCILanguageModel(modelId, config),
  };
}
```

### 2. Authentication Cascade
- Environment variables override constructor
- Constructor overrides config file
- Config file overrides defaults
- Supports all OCI auth methods

**Priority Order**:
```
1. Environment (OCI_REGION, OCI_CONFIG_PROFILE)
2. Constructor options (region, profile)
3. Config file (~/.oci/config)
4. Defaults (eu-frankfurt-1, DEFAULT)
```

### 3. Streaming Architecture
- EventSource parser for SSE
- Async iterator interface
- Backpressure handling
- Graceful disconnection

```typescript
async *generateStream(options: StreamOptions): AsyncIterator<string> {
  const parser = createParser(/* ... */);

  for await (const chunk of response.body) {
    parser.feed(chunk);
    // Yield text deltas
  }
}
```

### 4. Tool Calling Integration
- Zod schema acceptance
- JSON Schema conversion
- OCI GenAI format transformation
- Type-safe execution

**Conversion Flow**:
```
User Zod Schema → AI SDK JSON Schema → OCI Parameters
```

### 5. Error Handling Strategy
- Typed error classes
- Retry logic with exponential backoff
- Rate limit handling (429)
- Detailed error messages

```typescript
class OCIGenAIError extends Error {
  constructor(
    message: string,
    public statusCode?: number,
    public retryable?: boolean,
  ) {
    super(message);
  }
}
```

## Technology Stack

**File**: /docs/architecture/technology-stack.md

**Core Dependencies**:
- `@ai-sdk/provider` - Provider interface
- `oci-sdk` - OCI TypeScript SDK
- `eventsource-parser` - SSE parsing
- `zod` - Schema validation

**Development**:
- TypeScript 5.x
- ESLint + Prettier
- Vitest (testing)
- Husky (pre-commit hooks)

**CI/CD**:
- GitHub Actions
- npm publish automation
- Semantic versioning

## Code Conventions

**File**: /docs/architecture/code-conventions.md

**TypeScript Standards**:
- Strict mode enabled
- ESM modules (`.js` extensions in imports)
- Explicit return types
- No `any` types (use `unknown`)

**Naming Conventions**:
- Classes: PascalCase (`OCILanguageModel`)
- Functions: camelCase (`generateText`)
- Constants: UPPER_SNAKE_CASE (`DEFAULT_REGION`)
- Files: kebab-case (`oci-language-model.ts`)

**Code Organization**:
```typescript
// 1. Imports (external first, then internal)
import { LanguageModelV3 } from '@ai-sdk/provider';
import { createAuth } from './auth/index.js';

// 2. Types and interfaces
interface OCIConfig {
  region?: string;
  profile?: string;
}

// 3. Implementation
export class OCILanguageModel implements LanguageModelV3 {
  // ...
}

// 4. Exports
export { createOCI } from './provider.js';
```

**Error Handling Pattern**:
```typescript
try {
  const result = await operation();
  return result;
} catch (error) {
  if (error instanceof OCIGenAIError) {
    // Handle OCI-specific errors
  }
  throw new OCIGenAIError(`Operation failed: ${error.message}`);
}
```

## Security Best Practices

**File**: /docs/security/README.md

### Authentication Security

**Credential Storage**:
- API keys in `~/.oci/config` (chmod 600)
- Environment variables for CI/CD
- Secrets management (OCI Vault)
- Never commit credentials

**Key Rotation**:
- Regular rotation schedule (90 days)
- Automated rotation for production
- Multiple keys for zero-downtime rotation

**Least Privilege**:
```
Allow group Developers to use generative-ai-family in compartment AI-Dev
# Do NOT grant manage or delete permissions
```

### Network Security

**HTTPS Only**:
- All API calls use TLS 1.2+
- Certificate validation enabled
- No plaintext communication

**Private Endpoints** (production):
- VCN integration
- Private subnet deployment
- No public internet access

### Input Validation

**Prompt Sanitization**:
```typescript
function sanitizePrompt(prompt: string): string {
  // Remove control characters
  return prompt.replace(/[\x00-\x1F\x7F]/g, '');
}
```

**Parameter Validation**:
```typescript
function validateConfig(config: OCIConfig): void {
  if (config.region && !VALID_REGIONS.includes(config.region)) {
    throw new Error(`Invalid region: ${config.region}`);
  }
}
```

### Command Execution Safety

**Use execFile with separate arguments** to prevent command injection:

```typescript
import { execFile } from 'child_process';
import { promisify } from 'util';

const execFileAsync = promisify(execFile);

// Safe - command and arguments are separate
await execFileAsync('git', ['status', '--porcelain']);
await execFileAsync('npm', ['install', packageName]);
```

**Use execFileNoThrow utility** from codebase:
```typescript
import { execFileNoThrow } from '../utils/execFileNoThrow.js';

const result = await execFileNoThrow('git', ['status', '--porcelain']);
if (result.exitCode === 0) {
  console.log(result.stdout);
}
```

**Key Security Principles**:
- Always use execFile, never use exec or shell: true
- Pass command arguments as array elements
- Never interpolate user input into command strings
- Validate and sanitize all inputs
- Use the project's execFileNoThrow utility for consistency

### Dependency Security

**Audit Dependencies**:
```bash
npm audit
npm audit fix
```

**Lock File**:
- Commit `package-lock.json`
- Review dependency updates
- Use Dependabot for alerts

**Secure Libraries** (from security guidance):
- Helmet.js (HTTP headers)
- DOMPurify (XSS prevention)
- Google Tink (cryptography)

### Rate Limiting

**Client-Side**:
```typescript
class RateLimiter {
  private tokens: number;
  private lastRefill: number;

  async acquire(): Promise<void> {
    while (this.tokens < 1) {
      await this.refill();
    }
    this.tokens--;
  }
}
```

**Error Handling**:
```typescript
if (error.statusCode === 429) {
  const retryAfter = error.headers['retry-after'];
  await sleep(retryAfter * 1000);
  return retry();
}
```

### Logging and Monitoring

**Security Events**:
- Authentication failures
- Rate limit hits
- Invalid requests
- Unusual patterns

**Log Sanitization**:
```typescript
function sanitizeLog(data: any): any {
  const sanitized = { ...data };
  delete sanitized.apiKey;
  delete sanitized.token;
  delete sanitized.password;
  return sanitized;
}
```

**Audit Trail**:
- OCI Audit service integration
- Request/response logging
- User action tracking
- Compliance reporting

## Testing Strategy

**Main Documentation**: /docs/testing/README.md

**Test-Driven Development (TDD)**:
- **121 comprehensive tests** across 14 test files
- **RED-GREEN-REFACTOR** cycles with atomic commits
- **80%+ coverage** target (branches, functions, lines, statements)
- Implementation plan: /docs/plans/2026-01-27-core-provider-tdd-implementation.md

**Test Suite Breakdown**:
- Type definitions: 3 tests
- Authentication: 4 tests
- Model registry: 28 tests (16+ models)
- Message conversion: 9 tests
- Language model doGenerate: 22 tests
- SSE parser: 11 tests
- doStream: 8 tests
- Provider factory: 16 tests
- Error handling: 20 tests

**Test Organization**:
```
packages/oci-genai-provider/
├── src/
│   ├── __tests__/
│   │   ├── setup.ts              # Global test setup
│   │   ├── types.test.ts         # Type validation
│   │   ├── errors.test.ts        # Error handling
│   │   └── provider.test.ts      # Factory tests
│   ├── auth/__tests__/
│   │   └── auth.test.ts          # Auth providers
│   ├── models/__tests__/
│   │   ├── registry.test.ts      # Model catalog
│   │   ├── oci-language-model.test.ts       # doGenerate
│   │   └── oci-language-model.stream.test.ts # doStream
│   ├── converters/__tests__/
│   │   └── messages.test.ts      # Message conversion
│   └── streaming/__tests__/
│       └── sse-parser.test.ts    # SSE parsing
```

**Shared Test Utilities** (@acedergren/test-utils):
```typescript
import { TEST_CONFIG, TEST_MODEL_IDS, TEST_OCIDS } from '@acedergren/test-utils';

// OCI SDK mocks automatically available
jest.mock('oci-common');
jest.mock('oci-generativeaiinference');

const model = oci(TEST_MODEL_IDS.cohere, TEST_CONFIG);
```

**Running Tests**:
```bash
# All packages
pnpm test

# Specific package
pnpm --filter @acedergren/oci-genai-provider test

# Watch mode
pnpm --filter @acedergren/oci-genai-provider test -- --watch

# Coverage report
pnpm test:coverage
```

**TDD Workflow**:
```
1. RED:    Write failing test → pnpm test (FAIL)
2. GREEN:  Write minimal code → pnpm test (PASS)
3. REFACTOR: Improve code   → pnpm test (PASS)
4. COMMIT: Atomic commit with passing tests
```

**Example Test** (Jest with TypeScript):
```typescript
import { describe, it, expect } from '@jest/globals';
import { createOCI } from '../index';
import { TEST_CONFIG, TEST_MODEL_IDS } from '@acedergren/test-utils';

describe('createOCI Provider Factory', () => {
  it('should create provider with default config', () => {
    const provider = createOCI();
    expect(provider.provider).toBe('oci-genai');
    expect(typeof provider.model).toBe('function');
  });

  it('should create model with config', () => {
    const provider = createOCI(TEST_CONFIG);
    const model = provider.model(TEST_MODEL_IDS.cohere);
    expect(model.modelId).toBe('cohere.command-r-plus');
    expect(model.provider).toBe('oci-genai');
  });
});
```

## Performance Optimization

**Connection Pooling**:
- Reuse HTTP connections
- Connection pool size: 10
- Keep-alive enabled

**Caching**:
- Model metadata (1 hour TTL)
- Authentication tokens (until expiry)
- Regional endpoints

**Streaming Optimization**:
- Chunk buffering (1KB)
- Backpressure handling
- Memory-efficient parsing

## Monitoring

**Metrics**:
- Request latency (P50, P95, P99)
- Token usage
- Error rates
- Model selection frequency

**Alerting**:
- Error rate > 5%
- Latency > 2s (P95)
- Authentication failures
- Rate limits

**Dashboard**:
- Real-time metrics
- Cost tracking
- Regional distribution
- Model usage patterns

## Contributing Guidelines

**Pull Request Process**:
1. Fork repository
2. Create feature branch
3. Write tests
4. Run linter and type checker
5. Submit PR with description

**Commit Messages**:
```
type(scope): description

feat(streaming): add backpressure handling
fix(auth): resolve token refresh issue
docs(api): update OCI SDK reference
```

**Code Review Checklist**:
- [ ] Tests pass
- [ ] Types are correct
- [ ] No security vulnerabilities
- [ ] Documentation updated
- [ ] Follows conventions

## Related Documentation

- API Reference: llms-api-reference.txt
- Implementation Guides: llms-guides.txt
- Model Catalog: llms-models.txt
- Tutorials: llms-use-cases.txt

## Archive Documentation

**Requirements Specification**:
- Original spec: /docs/archive/requirements-spec.md (1,420 lines)
- Comprehensive feature requirements
- Use case definitions
- Technical specifications

**Configuration**:
- OpenCode integration: /docs/guides/opencode-integration/configuration.md
- Environment setup
- Profile management

**IAM Policies**:
- Required policies: /docs/guides/iam-policies/required-policies.md
- Copy-paste templates
- Troubleshooting guide
