#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run lint-staged for automated fixes
npx lint-staged

# Check for secrets in staged files
echo "ğŸ”’ Checking for exposed secrets..."
if git diff --cached --name-only | grep -E '\.(env|pem|key)$'; then
  echo "âŒ Error: Attempting to commit sensitive files (.env, .pem, .key)"
  echo "Please remove these files from staging."
  exit 1
fi

# Check for hardcoded secrets in code
if git diff --cached | grep -iE '(api[_-]?key|secret|password|token|private[_-]?key|ghp_|gho_|github[_-]?token).*=.*["\047][^"\047]{20,}'; then
  echo "âš ï¸  Warning: Potential hardcoded secrets detected!"
  echo "Please review your changes and use environment variables instead."
  echo "Continuing in 3 seconds... Press Ctrl+C to cancel."
  sleep 3
fi

# Run type checking
echo "ğŸ“ Running TypeScript type checking..."
npm run type-check

# Run tests (only if TypeScript files are staged)
TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\\.ts$' | tr '\n' ' ')
if [ -n "$TS_FILES" ]; then
  echo "ğŸ§ª Running tests..."
  npm test -- --bail --findRelatedTests $TS_FILES
else
  echo "â„¹ï¸  No TypeScript files to test, skipping tests..."
fi

echo "âœ… Pre-commit checks passed!"
