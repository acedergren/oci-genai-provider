# Run lint-staged for automated fixes
npx lint-staged

# Check for secrets in staged files
echo "ğŸ”’ Checking for exposed secrets..."
if git diff --cached --name-only | grep -E '\.(env|pem|key)$'; then
  echo "âŒ Error: Attempting to commit sensitive files (.env, .pem, .key)"
  echo "Please remove these files from staging."
  exit 1
fi

# Check for hardcoded secrets in code
if git diff --cached | grep -iE '(api[_-]?key|secret|password|token|private[_-]?key|ghp_|gho_|github[_-]?token).*=.*["\047][^"\047]{20,}'; then
  echo "âš ï¸  Warning: Potential hardcoded secrets detected!"
  echo "Please review your changes and use environment variables instead."
  echo "Continuing in 3 seconds... Press Ctrl+C to cancel."
  sleep 3
fi

# Run type checking
echo "ğŸ“ Running TypeScript type checking..."
pnpm exec turbo run type-check

# Run tests only if TypeScript files in packages are staged
TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^packages/.*\.ts$' | tr '\n' ' ')
if [ -n "$TS_FILES" ]; then
  echo "ğŸ§ª Running tests..."
  pnpm exec turbo run test
else
  echo "ğŸ“ No package TypeScript files staged, skipping tests..."
fi

echo "âœ… Pre-commit checks passed!"
